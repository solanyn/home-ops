apiVersion: admissionregistration.k8s.io/v1alpha1
kind: MutatingAdmissionPolicy
metadata:
  name: set-default-container-resources
spec:
  matchConstraints:
    resourceRules:
      - apiGroups: ["apps"]
        apiVersions: ["v1"]
        operations: ["CREATE", "UPDATE"]
        resources: ["deployments", "statefulsets", "replicasets", "daemonsets"]
  mutations:
    - patchType: JSONPatch
      jsonPatch:
        expression: |
          let containerPatches = has(object.spec.template.spec.containers) ?
            object.spec.template.spec.containers.indices().map(i,
              '{"op": "add", "path": "/spec/template/spec/containers/' + string(i) + '/resources", "value": {"requests": {"cpu": "10m", "memory": "64Mi"}}}'
            ) : [];
          let initContainerPatches = has(object.spec.template.spec.initContainers) ?
            object.spec.template.spec.initContainers.indices().map(i,
              '{"op": "add", "path": "/spec/template/spec/initContainers/' + string(i) + '/resources", "value": {"requests": {"cpu": "10m", "memory": "64Mi"}}}'
            ) : [];
          let allPatches = containerPatches + initContainerPatches;
          "[" + allPatches.join(",") + "]"
  reinvocationPolicy: IfNeeded
---
apiVersion: admissionregistration.k8s.io/v1alpha1
kind: MutatingAdmissionPolicyBinding
metadata:
  name: set-default-container-resources
spec:
  policyName: set-default-container-resources
