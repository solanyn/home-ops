---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/app-template-4.6.2/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: metadata
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: metadata
  values:
    controllers:
      grpc:
        replicas: 1
        serviceAccount:
          name: metadata-grpc-server
        initContainers:
          init-db:
            image:
              repository: ghcr.io/home-operations/postgres-init
              tag: 18
            envFrom:
              - secretRef:
                  name: metadata-db-secret
        containers:
          app:
            image:
              repository: gcr.io/tfx-oss-public/ml_metadata_store_server
              tag: 1.17.0
            command: ["/bin/metadata_store_server"]
            args:
              - --grpc_port=8080
              - --pg_config_dbname=$(PG_DATABASE)
              - --pg_config_host=$(PG_HOST)
              - --pg_config_port=$(PG_PORT)
              - --pg_config_user=$(DBCONFIG_USER)
              - --pg_config_password=$(DBCONFIG_PASSWORD)
              - --enable_database_upgrade=true
              - --grpc_channel_arguments=grpc.max_metadata_size=16384
            envFrom:
              - secretRef:
                  name: metadata-db-secret
            ports:
              - name: grpc-api
                containerPort: 8080
            securityContext:
              runAsNonRoot: true
              runAsUser: 1000
              capabilities:
                drop: ["ALL"]
      
      envoy:
        replicas: 1
        containers:
          app:
            image:
              repository: ghcr.io/kubeflow/kfp-metadata-envoy
              tag: 2.15.0
            args: ["/etc/envoy/envoy-config.yaml"]
            ports:
              - name: md-envoy
                containerPort: 9090
            securityContext:
              runAsNonRoot: true
              runAsUser: 1000
              capabilities:
                drop: ["ALL"]
    
    service:
      grpc:
        controller: grpc
        ports:
          grpc:
            port: 8080
      envoy:
        controller: envoy
        ports:
          http:
            port: 9090

    configMaps:
      envoy-config:
        name: metadata-envoy-config
        data:
          envoy-config.yaml: |
            # Minimal Envoy config for MLMD
            static_resources:
              listeners:
              - name: listener_0
                address:
                  socket_address: { address: 0.0.0.0, port_value: 9090 }
                filter_chains:
                - filters:
                  - name: envoy.filters.network.http_connection_manager
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                      codec_type: auto
                      stat_prefix: ingress_http
                      route_config:
                        name: local_route
                        virtual_hosts:
                        - name: local_service
                          domains: ["*"]
                          routes:
                          - match: { prefix: "/" }
                            route: { cluster: metadata_service }
                      http_filters:
                      - name: envoy.filters.http.router
                        typed_config:
                          "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
              clusters:
              - name: metadata_service
                connect_timeout: 0.25s
                type: logical_dns
                lb_policy: round_robin
                load_assignment:
                  cluster_name: metadata_service
                  endpoints:
                  - lb_endpoints:
                    - endpoint:
                        address:
                          socket_address:
                            address: 127.0.0.1
                            port_value: 8080
    
    persistence:
      envoy-config:
        type: configMap
        name: metadata-envoy-config
        globalMounts:
          - path: /etc/envoy/envoy-config.yaml
            subPath: envoy-config.yaml
            readOnly: true
