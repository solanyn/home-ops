---
apiVersion: source.toolkit.fluxcd.io/v1
kind: GitRepository
metadata:
  name: kubeflow
  namespace: kubeflow
spec:
  ignore: |
    # exclude all
    /*
    # include charts directory
    !/charts/
  interval: 12h
  ref:
    branch: helmcharts
  url: https://github.com/kromanow94/kubeflow-manifests
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kubeflow
spec:
  interval: 1h
  chart:
    spec:
      chart: ./charts/kubeflow
      version: 0.4.0
      sourceRef:
        kind: GitRepository
        name: kubeflow
        namespace: kubeflow
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    pipelines:
      config:
        db:
          driver:
            value: mysql
          user: &dbUser
            secretKeyRef:
              name: kubeflow-secret
              key: MARIADB_KUBEFLOW_USER
          password: &dbPass
            secretKeyRef:
              name: kubeflow-secret
              key: MARIADB_KUBEFLOW_PASSWORD
          host:
            value: &dbHost mariadb.database.svc.cluster.local
          port:
            value: 3306
          databaseName:
            value: kubeflow_pipelines
        objectStore:
          accessKey:
            secretKeyRef:
              name: kubeflow-secret
              key: AWS_ACCESS_KEY_ID
          secretAccessKey:
            secretKeyRef:
              name: kubeflow-secret
              key: AWS_SECRET_ACCESS_KEY
    katib:
      dbmanager:
        config:
          driver:
            value: mysql
          db:
            user: *dbUser
            password: *dbPass
          host:
            value: *dbHost
          port:
            value: 3306
          databaseName:
            value: kubeflow_katib
    notebooks:
      jupyterWebApp:
        spawnerFormDefaults:
          configurations:
            value:
              - access-ml-pipeline
    dexIntegration:
      svc:
        namespace: dex
    oauth2ProxyIntegration:
      svc:
        namespace: oauth2-proxy
    knativeIntegration:
      knativeServing:
        name: knative-serving
        namespace: kubeflow
        operatorSpec:
          version: 1.10.2
          ingress:
            istio:
              enabled: true
              knative-ingress-gateway:
                selector:
                  istio: ingress-gateway
                servers:
                  - port:
                      number: 80
                      name: http
                      protocol: HTTP
                    hosts:
                    - "*"
              knative-local-gateway:
                selector:
                  istio: cluster-local-gateway
                servers:
                  - port:
                      number: 80
                      name: http
                      protocol: HTTP
                    hosts:
                    - "*"
          config:
            # Note: The configuration options may be copied out of
            # the example blocks, found in each of the supported KNative ConfigMaps.
            # For more information, visit official knative operator documentation:
            # https://knative.dev/docs/install/operator/configuring-with-operator/
            istio:
              gateway.knative-serving.knative-ingress-gateway: "istio-ingressgateway.kubeflow.svc.cluster.local"
              local-gateway.knative-serving.knative-local-gateway: "cluster-local-gateway.kubeflow.svc.cluster.local"
              external-gateways: |
                - name: knative-ingress-gateway
                  namespace: kubeflow
                  service: istio-ingressgateway.kubeflow.svc.cluster.local
              local-gateways: |
                - name: knative-local-gateway
                  namespace: kubeflow
                  service: cluster-local-gateway.kubeflow.svc.cluster.local
            domain:
              goyangi.cloud: ""
      knativeEventing:
        enabled: true
        namespace: kubeflow
