# yaml-language-server: $schema=https://kubernetes-schemas.solanyn.dev/external-secrets.io/externalsecret_v1beta1.json
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: dex
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: dex-secret
    template:
      data:
        INIT_POSTGRES_DBNAME: dex
        INIT_POSTGRES_HOST: postgres17-rw.database.svc.cluster.local
        INIT_POSTGRES_USER: "{{ .KUBEFLOW_DEX_POSTGRES_USER }}"
        INIT_POSTGRES_PASS: "{{ .KUBEFLOW_DEX_POSTGRES_PASSWORD }}"
        INIT_POSTGRES_SUPER_PASS: "{{ .POSTGRES_SUPER_PASS }}"
        OIDC_CLIENT_ID: "{{ .KUBEFLOW_DEX_OIDC_CLIENT_ID }}"
        OIDC_CLIENT_SECRET: "{{ .KUBEFLOW_DEX_OIDC_CLIENT_SECRET }}"
        config.yaml: |
          issuer: http://dex.dex.svc.cluster.local:5556/dex
          storage:
            type: postgres
            config:
              host: postgres17-rw.database.svc.cluster.local
              port: 5432
              database: dex
              user: "{{ .KUBEFLOW_DEX_POSTGRES_USER }}"
              password: "{{ .KUBEFLOW_DEX_POSTGRES_PASSWORD }}"
              ssl:
                mode: disable
          web:
            http: 0.0.0.0:5556
          logger:
            level: "debug"
            format: "text"
          oauth2:
            skipApprovalScreen: true
          staticClients:
          - idEnv: OIDC_CLIENT_ID
            name: 'Dex Login Application'
            redirectURIs:
            - /oauth2/callback
            secretEnv: OIDC_CLIENT_SECRET
          enablePasswordDB: true
  dataFrom:
    - extract:
        key: cloudnative-pg
    - extract:
        key: kubeflow

