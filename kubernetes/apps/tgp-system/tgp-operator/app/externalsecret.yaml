# yaml-language-server:$schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: tgp-operator
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: tgp-operator-secret
    template:
      data:
        PAPERSPACE_API_KEY: "{{ .PAPERSPACE_API_KEY }}"
        LAMBDA_LABS_API_KEY: "{{ .LAMBDA_LABS_API_KEY }}"
        RUNPOD_API_KEY: "{{ .RUNPOD_API_KEY }}"
        client-id: "{{ .TAILSCALE_CLIENT_ID }}"
        client-secret: "{{ .TAILSCALE_CLIENT_SECRET }}"
        tgp-node-config: |
          version: v1alpha1
          machine:
            type: worker
            token: "{{ .MACHINE_TOKEN }}"
            ca:
              crt: "{{ .MACHINE_CA_CRT }}"
            kubelet:
              image: {{`{{.KubeletImage}}`}}
              extraConfig:
                maxPods: 2000
            install:
              image: {{`{{.TalosImage}}`}}
            network:
              hostname: {{`{{.NodeName}}`}}
            sysctls:
              fs.inotify.max_user_watches: 1048576
              fs.inotify.max_user_instances: 8192
            features:
              rbac: true
              stableHostname: true
              kubernetesTalosAPIAccess:
                enabled: true
                allowedRoles:
                  - os:admin
                allowedKubernetesNamespaces:
                  - tgp-system
            nodeLabels:
              tgp.io/provider: {{`{{.Provider}}`}}
              tgp.io/region: {{`{{.Region}}`}}
              tgp.io/node-pool: {{`{{.NodePoolName}}`}}
              tgp.io/provisioned: "true"
          cluster:
            id: "{{ .CLUSTER_ID }}"
            secret: "{{ .CLUSTER_SECRET }}"
            controlPlane:
              endpoint: {{`{{.ControlPlaneEndpoint}}`}}
            clusterName: "{{ .CLUSTER_NAME }}"
            token: "{{ .CLUSTER_TOKEN }}"
            ca:
              crt: "{{ .CLUSTER_CA_CRT }}"
  dataFrom:
    - extract:
        key: tgp-operator
    - extract:
        key: tailscale
    - extract:
        key: talos
