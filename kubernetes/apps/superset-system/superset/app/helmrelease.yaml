---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrepository-source-v1beta2.json
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: superset
  namespace: superset-system
spec:
  interval: 12h
  url: http://apache.github.io/superset/
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/source.toolkit.fluxcd.io/ocirepository_v1beta2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: superset
spec:
  interval: 30m
  chart:
    spec:
      chart: superset
      version: 0.14.2
      sourceRef:
        kind: HelmRepository
        name: superset
        namespace: superset-system
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    fullnameOverride: superset
    runAsUser: 1000
    bootstrapScript: |
      #!/bin/bash

      # Install system-level dependencies
      apt-get update && apt-get install -y \
        python3-dev \
        build-essential \
        pkg-config

      # Install required Python packages
      pip install \
        authlib \
        psycopg2-binary \

      # Create bootstrap file if it doesn't exist
      if [ ! -f ~/bootstrap ]; then
        echo "Running Superset with uid {{ .Values.runAsUser }}" > ~/bootstrap
      fi
    secretEnv:
      create: false
    envFromSecret: superset-secret
    supersetNode:
      connections:
        redis_host: redis.database.svc.cluster.local
        redis_port: "6379"
      initContainers: []
    supersetWorker:
      initContainers: []
    init:
      initContainers:
        - name: init-db
          image:
            repository: ghcr.io/home-operations/postgres-init:17
          envFrom:
            - secretRef:
                name: superset-secret
    postgresql:
      enabled: false
    redis:
      enabled: false
  valuesFrom:
    - kind: Secret
      name: superset-secret
