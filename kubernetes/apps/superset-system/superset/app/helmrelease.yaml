---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrepository-source-v1beta2.json
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: superset
  namespace: superset-system
spec:
  interval: 12h
  url: http://apache.github.io/superset/
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/source.toolkit.fluxcd.io/ocirepository_v1beta2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: superset
spec:
  interval: 30m
  chart:
    spec:
      chart: superset
      version: 0.14.2
      sourceRef:
        kind: HelmRepository
        name: superset
        namespace: superset-system
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    fullnameOverride: superset
    runAsUser: 1000
    bootstrapScript: |
      #!/bin/bash

      # Install required Python packages
      pip install \
        pyhive \
        Pillow \
        psycopg2-binary

      # Create bootstrap file if it doesn't exist
      if [ ! -f ~/bootstrap ]; then
        echo "Running Superset with uid {{ .Values.runAsUser }}" > ~/bootstrap
      fi
    secretEnv:
      create: false
    envFromSecret: superset-secret
    configOverrides:
      celery_config: |
        class CeleryConfig(object):
            broker_url = f'redis://{os.environ["REDIS_HOST"]}:{os.environ["REDIS_PORT"]}/0'
            imports = (
                "superset.sql_lab",
                "superset.tasks.scheduler",
            )
            result_backend = f'redis://{os.environ["REDIS_HOST"]}:{os.environ["REDIS_PORT"]}/0'
            worker_prefetch_multiplier = 10
            task_acks_late = True
            task_annotations = {
                "sql_lab.get_sql_results": {
                    "rate_limit": "100/s",
                },
            }

        CELERY_CONFIG = CeleryConfig
        from flask_caching.backends.rediscache import RedisCache
        RESULTS_BACKEND = RedisCache(
            host=os.environ["REDIS_HOST"], port=os.environ["REDIS_PORT"], key_prefix='superset_results')

    supersetNode:
      connections:
        redis_host: redis.database.svc.cluster.local
        redis_port: "6379"
      forceReload: true
      initContainers:
        - name: init-db
          image: ghcr.io/home-operations/postgres-init:17
          envFrom:
            - secretRef:
                name: superset-secret
    postgresql:
      enabled: false
    redis:
      enabled: false
  valuesFrom:
    - kind: Secret
      name: superset-secret
