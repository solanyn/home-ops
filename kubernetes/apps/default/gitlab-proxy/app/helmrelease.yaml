---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: gitlab-proxy
spec:
  chartRef:
    kind: OCIRepository
    name: gitlab-proxy
  interval: 1h
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    controllers:
      gitlab-proxy:
        containers:
          nginx:
            image:
              repository: nginx
              tag: alpine
            env:
              GITLAB_URL:
                valueFrom:
                  secretKeyRef:
                    name: forgejo-secret
                    key: GITLAB_MIRROR_URL
            probes:
              liveness:
                enabled: false
              readiness:
                enabled: false

    configMaps:
      config:
        data:
          default.conf.template: |
            resolver kube-dns.kube-system.svc.cluster.local valid=5s;
            server {
              listen 443 ssl;
              ssl_certificate /certs/tls.crt;
              ssl_certificate_key /certs/tls.key;

              location / {
                proxy_pass ${GITLAB_URL};
                proxy_ssl_certificate /client-certs/client.crt;
                proxy_ssl_certificate_key /client-certs/client.key;
                proxy_ssl_verify off;
                proxy_ssl_server_name on;
                proxy_set_header Host $proxy_host;
              }
            }

    service:
      gitlab-proxy:
        controller: gitlab-proxy
        ports:
          https:
            port: 443

    persistence:
      config:
        type: configMap
        name: gitlab-proxy
        globalMounts:
          - path: /etc/nginx/templates/default.conf.template
            subPath: default.conf.template
      server-certs:
        type: secret
        name: gitlab-proxy-tls
        globalMounts:
          - path: /certs
      client-certs:
        type: secret
        name: forgejo-gitlab-mirror-secret
        globalMounts:
          - path: /client-certs
