---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: gitlab-proxy
spec:
  chartRef:
    kind: OCIRepository
    name: gitlab-proxy
  interval: 1h
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    controllers:
      gitlab-proxy:
        containers:
          nginx:
            image:
              repository: nginx
              tag: alpine
            envFrom:
              - secretRef:
                  name: gitlab-proxy-secret
            probes:
              liveness:
                enabled: false
              readiness:
                enabled: false

    configMaps:
      config:
        data:
          default.conf.template: |
            resolver kube-dns.kube-system.svc.cluster.local valid=5s;
            server {
              listen 443 ssl;
              ssl_certificate /certs/tls.crt;
              ssl_certificate_key /certs/tls.key;

              location / {
                proxy_pass $GITLAB_MIRROR_URL;
                proxy_ssl_certificate /client-certs/client.crt;
                proxy_ssl_certificate_key /client-certs/client.key;
                proxy_ssl_verify off;
                proxy_ssl_server_name on;
                proxy_pass_request_headers on;
                proxy_set_header Authorization $http_authorization;

                sub_filter_types application/json;
                sub_filter_once off;
                sub_filter '$GITLAB_MIRROR_URL' 'https://gitlab-proxy';
              }
            }

    service:
      gitlab-proxy:
        controller: gitlab-proxy
        type: LoadBalancer
        ipFamilies: [IPv4, IPv6]
        ipFamilyPolicy: PreferDualStack
        annotations:
          lbipam.cilium.io/ips: 192.168.69.127,fd5d:a293:f321:69::127
        ports:
          https:
            port: 443

    persistence:
      config:
        type: configMap
        name: gitlab-proxy
        globalMounts:
          - path: /etc/nginx/templates/default.conf.template
            subPath: default.conf.template
      server-certs:
        type: secret
        name: gitlab-proxy-tls
        globalMounts:
          - path: /certs
      client-certs:
        type: secret
        name: gitlab-proxy-secret
        items:
          - key: client.crt
            path: client.crt
          - key: client.key
            path: client.key
        globalMounts:
          - path: /client-certs
