---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: forgejo
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: forgejo
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    replicaCount: 1

    service:
      http:
        type: ClusterIP
        port: 3000
      ssh:
        type: LoadBalancer
        port: 22
        annotations:
          lbipam.cilium.io/ips: 192.168.69.125

    ingress:
      enabled: false

    gitea:
      admin:
        existingSecret: forgejo-secret

      config:
        server:
          ROOT_URL: https://forgejo.goyangi.io/
          DOMAIN: forgejo.goyangi.io
          SSH_DOMAIN: forgejo.goyangi.io
          SSH_PORT: 22
          LANDING_PAGE: explore

        database:
          DB_TYPE: postgres
          HOST: postgres-rw.storage.svc.cluster.local:5432
          NAME: forgejo
          SSL_MODE: disable

        cache:
          ADAPTER: redis
          HOST: redis://redis.storage.svc.cluster.local:6379/0

        session:
          PROVIDER: redis
          PROVIDER_CONFIG: redis://redis.storage.svc.cluster.local:6379/2

        queue:
          TYPE: redis
          CONN_STR: redis://redis.storage.svc.cluster.local:6379/1

        indexer:
          ISSUE_INDEXER_TYPE: db

        storage:
          STORAGE_TYPE: minio
          MINIO_ENDPOINT: garage.storage.svc.cluster.local:3900
          MINIO_BUCKET: forgejo
          MINIO_LOCATION: us-east-1
          MINIO_USE_SSL: false

        mailer:
          ENABLED: true
          PROTOCOL: smtp
          SMTP_ADDR: smtp-relay.network.svc.cluster.local
          SMTP_PORT: 25
          FROM: noreply@goyangi.io

        openid:
          ENABLE_OPENID_SIGNIN: true
          ENABLE_OPENID_SIGNUP: false

        service:
          DISABLE_REGISTRATION: true

        # git.config with URL-based keys moved to lifecycle postStart
        # to avoid env var conversion issues

      additionalConfigFromEnvs:
        - name: GITEA__database__USER
          valueFrom:
            secretKeyRef:
              name: forgejo-secret
              key: GITEA__database__USER
        - name: GITEA__database__PASSWD
          valueFrom:
            secretKeyRef:
              name: forgejo-secret
              key: GITEA__database__PASSWD
        - name: GITEA__storage__MINIO_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              name: forgejo-secret
              key: GITEA__storage__MINIO_ACCESS_KEY_ID
        - name: GITEA__storage__MINIO_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: forgejo-secret
              key: GITEA__storage__MINIO_SECRET_ACCESS_KEY

    postgresql:
      enabled: false

    redis-cluster:
      enabled: false

    persistence:
      enabled: true
      create: false
      claimName: forgejo

    extraVolumes:
      - name: gitlab-certs
        secret:
          secretName: forgejo-gitlab-mirror-secret
          items:
            - key: client.crt
              path: client.crt
            - key: client.key
              path: client.key
      - name: gitconfig
        secret:
          secretName: forgejo-secret
          items:
            - key: gitconfig
              path: .gitconfig

    extraContainerVolumeMounts:
      - name: gitlab-certs
        mountPath: /gitlab-certs
        readOnly: true
      - name: gitconfig
        mountPath: /data/git/.gitconfig
        subPath: .gitconfig
        readOnly: true

    resources:
      requests:
        cpu: 10m
        memory: 256Mi
      limits:
        memory: 1Gi
