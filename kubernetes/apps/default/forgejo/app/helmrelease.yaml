apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: forgejo
spec:
  interval: 30m
  chart:
    spec:
      chart: forgejo
      version: "5.x"
      sourceRef:
        kind: HelmRepository
        name: forgejo
  values:
    replicaCount: 1

    image:
      repository: codeberg.org/forgejo/forgejo
      tag: latest
      pullPolicy: IfNotPresent

    service:
      http:
        type: ClusterIP
        port: 3000
      ssh:
        type: LoadBalancer
        port: 22
        externalIPs:
          - 192.168.222.125

    ingress:
      enabled: false

    forgejo:
      admin:
        existingSecret: forgejo-secret
        username: admin

      server:
        HTTP_ADDR: "0.0.0.0"
        HTTP_PORT: 3000
        ROOT_URL: "https://forgejo.goyangi.io/"
        DOMAIN: "forgejo.goyangi.io"
        SSH_DOMAIN: "ssh.forgejo.goyangi.io"
        SSH_PORT: 22
        SSH_LISTEN_HOST: "0.0.0.0"
        SSH_LISTEN_PORT: 22
        LANDING_PAGE: "explore"
        DISABLE_REGISTRATION: "true"
        ENABLE_PUSH_CREATE_USER: "false"

      database:
        DB_TYPE: "postgres"
        HOST: postgres-rw.storage.svc.cluster.local:5432
        NAME: "forgejo"
        USER: "forgejo"
        PASSWD: ""
        SSL_MODE: "disable"
        SCHEMA: "public"

      cache:
        ADAPTER: "redis"
        HOST: "dragonfly.storage.svc.cluster.local:6379"
        DB: "0"

      session:
        PROVIDER: "redis"
        PROVIDER_CONFIG: "dragonfly.storage.svc.cluster.local:6379/2"

      queue:
        TYPE: "redis"

      indexer:
        ISSUE_INDEXER_TYPE: "db"

      storage:
        STORAGE_TYPE: "s3"
        S3_ENDPOINT: "garage.storage.svc.cluster.local:3900"
        S3_ACCESS_KEY_ID: ""
        S3_SECRET_ACCESS_KEY: ""
        S3_BUCKET: "forgejo"
        S3_REGION: "garage"
        S3_PATH_PREFIX: ""
        S3_USE_PATH_STYLE: "true"
        S3_SKIP_TLS_VERIFY: "true"

      auth:
        DISABLE_REGISTRATION: "true"

      openid:
        ENABLE_OPENID_SIGNIN: "true"
        ENABLE_OPENID_SIGNUP: "true"
        WHITELISTED_URIS: ""

      mailer:
        ENABLED: "true"
        PROTOCOL: "smtp"
        SMTP_ADDR: "smtp-relay.network.svc.cluster.local"
        SMTP_PORT: "25"
        FROM: "noreply@goyangi.io"
        USER: ""
        PASSWD: ""

    postgresql:
      enabled: false

    redis:
      enabled: false

    memcached:
      enabled: false

    persistence:
      enabled: true
      size: 10Gi
      storageClassName: ceph-block
      mount: /data

    securityContext:
      runAsNonRoot: true
      runAsUser: 1000
      runAsGroup: 1000
      fsGroup: 1000
      fsGroupChangePolicy: OnRootMismatch
      seccompProfile:
        type: RuntimeDefault
      capabilities:
        drop:
          - ALL
        add:
          - SYS_CHROOT

    containerSecurityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: false
      capabilities:
        drop:
          - ALL
        add:
          - SYS_CHROOT

    resources:
      requests:
        cpu: 10m
        memory: 256Mi
      limits:
        memory: 2Gi

    metrics:
      enabled: true
      serviceMonitor:
        enabled: true
