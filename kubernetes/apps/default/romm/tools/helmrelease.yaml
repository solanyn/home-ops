---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: romm-tools
spec:
  chartRef:
    kind: OCIRepository
    name: romm-tools
  interval: 1h
  values:
    controllers:
      switch-importer:
        type: cronjob
        cronjob:
          schedule: 0 * * * *
          backoffLimit: 0
          concurrencyPolicy: Forbid
          successfulJobsHistory: 1
          failedJobsHistory: 1
          ttlSecondsAfterFinished: 3600
        containers:
          app:
            image:
              repository: ghcr.io/astral-sh/uv
              tag: python3.12-alpine
            env:
              UV_CACHE_DIR: /tmp/uv-cache
            command:
              - uv
            args:
              - run
              - --with
              - nsz
              - python
              - /scripts/convert.py
            resources: {}
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities: { drop: ["ALL"] }
        pod:
          restartPolicy: Never
      cia-converter:
        type: cronjob
        cronjob:
          schedule: 0 * * * *
          backoffLimit: 0
          concurrencyPolicy: Forbid
          successfulJobsHistory: 1
          failedJobsHistory: 1
          ttlSecondsAfterFinished: 3600
        initContainers:
          download-tools:
            image:
              repository: alpine
              tag: 3.21
            command:
              - /bin/sh
              - -c
            args:
              - |
                apk add --no-cache wget unzip
                cd /tools
                wget -q https://github.com/shijimasoft/ctrdecrypt/releases/download/v1.1.0/ctrdecrypt-linux-x86_64.zip
                unzip -q ctrdecrypt-linux-x86_64.zip
                mv ctrdecrypt-linux-x86_64/ctrdecrypt .
                wget -q https://github.com/3DSGuy/Project_CTR/releases/download/ctrtool-v1.2.0/ctrtool-v1.2.0-ubuntu_x86_64.zip
                unzip -q ctrtool-v1.2.0-ubuntu_x86_64.zip
                mv ctrtool-v1.2.0-ubuntu_x86_64/ctrtool .
                wget -q https://github.com/3DSGuy/Project_CTR/releases/download/makerom-v0.18.4/makerom-v0.18.4-ubuntu_x86_64.zip
                unzip -q makerom-v0.18.4-ubuntu_x86_64.zip
                mv makerom-v0.18.4-ubuntu_x86_64/makerom .
                wget -q https://github.com/ihaveamac/3DS-rom-tools/raw/master/seeddb/seeddb.bin
                chmod +x ctrdecrypt ctrtool makerom
                rm -rf *.zip ctrdecrypt-* ctrtool-* makerom-*
        containers:
          app:
            image:
              repository: alpine
              tag: 3.21
            command:
              - /bin/sh
              - /scripts/cia-converter.sh
            resources: {}
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: false
              capabilities: { drop: ["ALL"] }
        pod:
          restartPolicy: Never
    defaultPodOptions:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch
    configMaps:
      script:
        data:
          convert.py: |
            #!/usr/bin/env python3
            import subprocess
            from pathlib import Path

            TORRENTS_DIRS = [
                Path("/media/downloads/torrents/complete/games"),
                Path("/media/downloads/torrents/complete/switch")
            ]
            ROMS_DIR = Path("/media/games/roms/switch")

            def process_files():
                for torrents_dir in TORRENTS_DIRS:
                    if not torrents_dir.exists():
                        continue

                    for nsz_file in torrents_dir.rglob("*.nsz"):
                        nsp_file = ROMS_DIR / nsz_file.with_suffix(".nsp").name
                        if nsp_file.exists():
                            print(f"Skipping {nsz_file}, {nsp_file.name} already exists")
                            continue
                        print(f"Converting {nsz_file} to {nsp_file}")
                        try:
                            subprocess.run(["nsz", "-D", str(nsz_file), "-o", str(ROMS_DIR)], check=True)
                            print(f"Converted {nsz_file}")
                        except subprocess.CalledProcessError as e:
                            print(f"Failed to convert {nsz_file}: {e}")
                            return

                    for nsp_file in torrents_dir.rglob("*.nsp"):
                        dest_file = ROMS_DIR / nsp_file.name
                        if dest_file.exists():
                            print(f"Skipping {nsp_file}, {dest_file.name} already exists")
                            continue
                        print(f"Hardlinking {nsp_file} to {dest_file}")
                        dest_file.hardlink_to(nsp_file)

            if __name__ == "__main__":
                process_files()
          cia-converter.sh: |
            #!/bin/sh
            set -e
            
            ROMS_DIR="/media/games/roms/3ds"
            TOOLS_DIR="/tools"
            
            cd "$ROMS_DIR"
            
            for cia in *.cia; do
                [ -f "$cia" ] || continue
                [ "${cia#*decrypted}" != "$cia" ] && continue
                
                cutn="${cia%.cia}"
                echo "Processing $cia"
                
                tmd=$("$TOOLS_DIR/ctrtool" --seeddb="$TOOLS_DIR/seeddb.bin" "$cia")
                
                if echo "$tmd" | grep -qi "T.*d.*00040000"; then
                    output="${cutn}-decrypted.cci"
                    [ -f "$output" ] && echo "Skipping $cia, $output exists" && continue
                    
                    echo "Type: Game"
                    "$TOOLS_DIR/ctrdecrypt" "$cia"
                    
                    args="-f cia -ignoresign -target p -o ${cutn}-decfirst.cia"
                    i=0
                    for ncch in ${cutn}.*.ncch; do
                        [ -f "$ncch" ] || continue
                        args="$args -i $ncch:$i:$i"
                        i=$((i + 1))
                    done
                    "$TOOLS_DIR/makerom" $args
                    "$TOOLS_DIR/makerom" -ciatocci "${cutn}-decfirst.cia" -o "$output"
                    rm -f "${cutn}-decfirst.cia" ${cutn}.*.ncch "$cia"
                    
                elif echo "$tmd" | grep -qiE "T.*d.*0004000[eE]"; then
                    output="${cutn} (Patch)-decrypted.cia"
                    [ -f "$output" ] && echo "Skipping $cia, $output exists" && continue
                    
                    echo "Type: Patch"
                    "$TOOLS_DIR/ctrdecrypt" "$cia"
                    
                    args="-f cia -ignoresign -target p -o $output"
                    i=0
                    for ncch in ${cutn}.*.ncch; do
                        [ -f "$ncch" ] || continue
                        args="$args -i $ncch:$i:$i"
                        i=$((i + 1))
                    done
                    "$TOOLS_DIR/makerom" $args
                    rm -f ${cutn}.*.ncch "$cia"
                    
                elif echo "$tmd" | grep -qiE "T.*d.*0004008[cC]"; then
                    output="${cutn} (DLC)-decrypted.cia"
                    [ -f "$output" ] && echo "Skipping $cia, $output exists" && continue
                    
                    echo "Type: DLC"
                    "$TOOLS_DIR/ctrdecrypt" "$cia"
                    
                    args="-f cia -dlc -ignoresign -target p -o $output"
                    i=0
                    for ncch in ${cutn}.*.ncch; do
                        [ -f "$ncch" ] || continue
                        args="$args -i $ncch:$i:$i"
                        i=$((i + 1))
                    done
                    "$TOOLS_DIR/makerom" $args
                    rm -f ${cutn}.*.ncch "$cia"
                fi
            done
    persistence:
      script:
        type: configMap
        identifier: script
        globalMounts:
          - path: /scripts
      media:
        type: nfs
        server: nas.internal
        path: /mnt/world/media
        globalMounts:
          - path: /media
      prod-keys:
        type: nfs
        server: nas.internal
        path: /mnt/world/media/games/bios/switch/20.5.0
        globalMounts:
          - path: /.switch/prod.keys
            subPath: prod.keys
            readOnly: true
      tools:
        type: emptyDir
        advancedMounts:
          cia-converter:
            download-tools:
              - path: /tools
            app:
              - path: /tools
      tmp:
        type: emptyDir
