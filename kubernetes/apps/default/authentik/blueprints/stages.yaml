version: 1
metadata:
  name: stages
entries:
  # Authentication stages
  - model: authentik_stages_identification.identificationstage
    identifiers:
      name: authentication-identification
    attrs:
      user_fields: []
      case_insensitive_matching: false
      show_source_labels: false
      show_matched_user: false
      passwordless_flow: !Find [authentik_flows.flow, [slug, passkey]]
      recovery_flow: !Find [authentik_flows.flow, [slug, account-recovery]]
      sources:
        - !Find [authentik_core.source, [managed, "goauthentik.io/sources/inbuilt"]]

  - model: authentik_stages_authenticator_validate.authenticatorvalidatestage
    identifiers:
      name: authentication-passkey-validation
    attrs:
      device_classes:
        - webauthn
      not_configured_action: deny
      webauthn_user_verification: preferred

  - model: authentik_stages_user_login.userloginstage
    identifiers:
      name: authentication-login

  # Invalidation stages
  - model: authentik_stages_user_logout.userlogoutstage
    identifiers:
      name: invalidation-logout

  # Admin backup stages
  - model: authentik_stages_identification.identificationstage
    identifiers:
      name: admin-backup-identification
    attrs:
      user_fields:
        - username
      password_stage: !Find [authentik_stages_password.passwordstage, [name, admin-password]]
      passwordless_flow: !Find [authentik_flows.flow, [slug, passkey]]
      case_insensitive_matching: false
      show_source_labels: false
      show_matched_user: true
      sources:
        - !Find [authentik_core.source, [managed, "goauthentik.io/sources/inbuilt"]]

  - model: authentik_stages_password.passwordstage
    identifiers:
      name: admin-password
    attrs:
      backends:
        - authentik.core.auth.InbuiltBackend

  - model: authentik_stages_authenticator_validate.authenticatorvalidatestage
    identifiers:
      name: admin-backup-totp
    attrs:
      device_classes:
        - totp
      not_configured_action: skip

  # Recovery stages
  - model: authentik_stages_identification.identificationstage
    identifiers:
      name: recovery-identification
    attrs:
      user_fields:
        - username
        - email
      case_insensitive_matching: false
      show_source_labels: false
      show_matched_user: false

  - model: authentik_stages_email.emailstage
    identifiers:
      name: recovery-email
    attrs:
      activate_user_on_success: true
      use_global_settings: true
      template: email/password_reset.html
      subject: Account recovery

  # Invitation stages
  - model: authentik_stages_invitation.invitationstage
    identifiers:
      name: enrollment-invitation
    attrs:
      continue_flow_without_invitation: false

  - model: authentik_stages_prompt.promptstage
    identifiers:
      name: source-enrollment-prompt
    attrs:
      fields:
        - !Find [authentik_stages_prompt.promptfield, [field_key, username]]
        - !Find [authentik_stages_prompt.promptfield, [field_key, name]]
        - !Find [authentik_stages_prompt.promptfield, [field_key, email]]

  - model: authentik_stages_authenticator_webauthn.authenticatorwebauthnstage
    identifiers:
      name: enrollment-passkey-setup
    attrs:
      user_verification: required
      authenticator_attachment: cross-platform
      resident_key_requirement: required

  - model: authentik_stages_user_write.userwritestage
    identifiers:
      name: enrollment-user-write
    attrs:
      create_users_as_inactive: false
      create_users_group: !Find [authentik_core.group, [name, users]]

  - model: authentik_stages_user_login.userloginstage
    identifiers:
      name: source-enrollment-login
    attrs:
      session_duration: "seconds=0"

  # User settings stages
  - model: authentik_stages_prompt.promptstage
    identifiers:
      name: user-settings
    attrs:
      fields:
        - !Find [authentik_stages_prompt.promptfield, [field_key, username]]
        - !Find [authentik_stages_prompt.promptfield, [field_key, name]]
        - !Find [authentik_stages_prompt.promptfield, [field_key, email]]
        - !Find [authentik_stages_prompt.promptfield, [field_key, "attributes.settings.locale"]]
      validation_policies:
        - !Find [authentik_policies_expression.expressionpolicy, [name, user-settings-authorization]]

  - model: authentik_stages_user_write.userwritestage
    identifiers:
      name: user-settings-write
    attrs:
      create_users_as_inactive: false

  # Prompt fields
  - model: authentik_stages_prompt.promptfield
    identifiers:
      field_key: username
    attrs:
      name: username
      required: true
      type: text
      label: Username
      initial_value: "try:\n    return user.username\nexcept:\n    return ''"
      initial_value_expression: true
      placeholder: "try:\n    return user.username\nexcept:\n    return ''"
      order: 200

  - model: authentik_stages_prompt.promptfield
    identifiers:
      field_key: name
    attrs:
      name: name
      type: text
      required: true
      label: Name
      initial_value: "try:\n    return user.name\nexcept:\n    return ''"
      initial_value_expression: true
      placeholder: "try:\n    return user.name\nexcept:\n    return ''"
      order: 201

  - model: authentik_stages_prompt.promptfield
    identifiers:
      field_key: email
    attrs:
      name: email
      type: email
      required: true
      label: Email
      initial_value: "try:\n    return user.email\nexcept:\n    return ''"
      initial_value_expression: true
      placeholder: "try:\n    return user.email\nexcept:\n    return ''"
      order: 202

  - model: authentik_stages_prompt.promptfield
    identifiers:
      field_key: "attributes.settings.locale"
    attrs:
      name: locale
      type: ak-locale
      required: true
      label: Locale
      initial_value: "try:\n    return user.attributes.get('settings', {}).get('locale', '')\nexcept:\n    return ''"
      initial_value_expression: true
      placeholder: "try:\n    return user.attributes.get('settings', {}).get('locale', '')\nexcept:\n    return ''"
      order: 203
