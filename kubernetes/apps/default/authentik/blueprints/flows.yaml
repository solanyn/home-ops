version: 1
metadata:
  name: flows
entries:
  # Passwordless authentication flow (usernameless)
  - model: authentik_flows.flow
    identifiers:
      slug: passkey
    attrs:
      name: passkey-flow
      title: Passkey Login
      designation: authentication
      policy_engine_mode: any

  # Authentication flow (username + passkey)
  - model: authentik_flows.flow
    identifiers:
      slug: authentication-flow
    attrs:
      name: authentication-flow
      title: Welcome!
      designation: authentication
      policy_engine_mode: any

  # Invalidation flow
  - model: authentik_flows.flow
    identifiers:
      slug: invalidation-flow
    attrs:
      name: invalidation-flow
      title: Invalidation Flow
      designation: invalidation
      policy_engine_mode: any
      denied_action: continue

  # Admin backup authentication flow (password-based)
  - model: authentik_flows.flow
    identifiers:
      slug: admin
    attrs:
      name: admin-flow
      title: Admin Login
      designation: authentication
      policy_engine_mode: any

  # Recovery flow (admin-initiated only)
  - model: authentik_flows.flow
    identifiers:
      slug: account-recovery
    attrs:
      name: recovery-flow
      title: Set up your passkey
      designation: recovery
      compatibility_mode: true

  # Invitation enrollment flow (passkey setup)
  - model: authentik_flows.flow
    identifiers:
      slug: enrollment-invitation
    attrs:
      name: enrollment-invitation-flow
      title: Set up your account
      designation: enrollment
      compatibility_mode: true

  # User settings flow
  - model: authentik_flows.flow
    identifiers:
      slug: user-settings-flow
    attrs:
      name: User settings
      title: Update your info
      designation: stage_configuration
      policy_engine_mode: any
      denied_action: message_continue

  # Authorization flow
  - model: authentik_flows.flow
    identifiers:
      slug: provider-authorization-implicit-consent
    attrs:
      name: Authorize Application
      title: "Redirecting to %(app)s"
      designation: authorization
      policy_engine_mode: any
      denied_action: message_continue

  # Flow stage bindings
  - model: authentik_flows.flowstagebinding
    identifiers:
      target: !Find [authentik_flows.flow, [slug, passkey]]
      stage: !Find [authentik_stages_authenticator_validate.authenticatorvalidatestage, [name, authentication-passkey-validation]]
      order: 0

  - model: authentik_flows.flowstagebinding
    identifiers:
      target: !Find [authentik_flows.flow, [slug, passkey]]
      stage: !Find [authentik_stages_user_login.userloginstage, [name, authentication-login]]
      order: 100

  - model: authentik_flows.flowstagebinding
    identifiers:
      target: !Find [authentik_flows.flow, [slug, authentication-flow]]
      stage: !Find [authentik_stages_identification.identificationstage, [name, authentication-identification]]
      order: 0

  - model: authentik_flows.flowstagebinding
    identifiers:
      target: !Find [authentik_flows.flow, [slug, authentication-flow]]
      stage: !Find [authentik_stages_authenticator_validate.authenticatorvalidatestage, [name, authentication-passkey-validation]]
      order: 10

  - model: authentik_flows.flowstagebinding
    identifiers:
      target: !Find [authentik_flows.flow, [slug, authentication-flow]]
      stage: !Find [authentik_stages_user_login.userloginstage, [name, authentication-login]]
      order: 100

  - model: authentik_flows.flowstagebinding
    identifiers:
      target: !Find [authentik_flows.flow, [slug, invalidation-flow]]
      stage: !Find [authentik_stages_user_logout.userlogoutstage, [name, invalidation-logout]]
      order: 0

  - model: authentik_flows.flowstagebinding
    identifiers:
      target: !Find [authentik_flows.flow, [slug, admin]]
      stage: !Find [authentik_stages_identification.identificationstage, [name, admin-backup-identification]]
      order: 0

  - model: authentik_flows.flowstagebinding
    identifiers:
      target: !Find [authentik_flows.flow, [slug, admin]]
      stage: !Find [authentik_stages_authenticator_validate.authenticatorvalidatestage, [name, admin-backup-totp]]
      order: 10

  - model: authentik_flows.flowstagebinding
    identifiers:
      target: !Find [authentik_flows.flow, [slug, admin]]
      stage: !Find [authentik_stages_user_login.userloginstage, [name, authentication-login]]
      order: 100

  - model: authentik_flows.flowstagebinding
    identifiers:
      target: !Find [authentik_flows.flow, [slug, account-recovery]]
      stage: !Find [authentik_stages_authenticator_webauthn.authenticatorwebauthnstage, [name, enrollment-passkey-setup]]
      order: 0

  - model: authentik_flows.flowstagebinding
    identifiers:
      target: !Find [authentik_flows.flow, [slug, enrollment-invitation]]
      stage: !Find [authentik_stages_invitation.invitationstage, [name, enrollment-invitation]]
      order: 0

  - model: authentik_flows.flowstagebinding
    identifiers:
      target: !Find [authentik_flows.flow, [slug, enrollment-invitation]]
      stage: !Find [authentik_stages_prompt.promptstage, [name, source-enrollment-prompt]]
      order: 10

  - model: authentik_flows.flowstagebinding
    identifiers:
      target: !Find [authentik_flows.flow, [slug, enrollment-invitation]]
      stage: !Find [authentik_stages_authenticator_webauthn.authenticatorwebauthnstage, [name, enrollment-passkey-setup]]
      order: 20

  - model: authentik_flows.flowstagebinding
    identifiers:
      target: !Find [authentik_flows.flow, [slug, enrollment-invitation]]
      stage: !Find [authentik_stages_user_write.userwritestage, [name, enrollment-user-write]]
      order: 30

  - model: authentik_flows.flowstagebinding
    identifiers:
      target: !Find [authentik_flows.flow, [slug, enrollment-invitation]]
      stage: !Find [authentik_stages_user_login.userloginstage, [name, source-enrollment-login]]
      order: 40

  - model: authentik_flows.flowstagebinding
    identifiers:
      target: !Find [authentik_flows.flow, [slug, user-settings-flow]]
      stage: !Find [authentik_stages_prompt.promptstage, [name, user-settings]]
      order: 20

  - model: authentik_flows.flowstagebinding
    identifiers:
      target: !Find [authentik_flows.flow, [slug, user-settings-flow]]
      stage: !Find [authentik_stages_user_write.userwritestage, [name, user-settings-write]]
      order: 100
