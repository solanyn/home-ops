---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: opencode-sandbox
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: opencode-sandbox-secret
    creationPolicy: Owner
    template:
      data:
        GITHUB_TOKEN: "{{ .GITHUB_MCP_SERVER_TOKEN }}"
  dataFrom:
    - extract:
        key: github
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: opencode-sandbox-config
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: opencode-sandbox-config
    creationPolicy: Owner
    template:
      data:
        opencode.json: |
          {
            "$schema": "https://opencode.ai/config.json",
            "model": "kgateway/kiro",
            "plugin": [
              "opencode-shell-strategy",
              "opencode-dynamic-context-pruning",
              "opencode-worktree"
            ],
            "provider": {
              "kgateway": {
                "api": "openai",
                "options": {
                  "apiKey": "{{ .AGENTGATEWAY_API_KEY }}",
                  "baseURL": "https://gateway.goyangi.io/v1/auto-coding"
                },
                "models": {
                  "kiro": {
                    "options": {
                      "baseURL": "https://gateway.goyangi.io/v1/kiro"
                    }
                  }
                }
              }
            },
            "mcp": {
              "context7": {
                "type": "remote",
                "url": "https://gateway.goyangi.io/mcp/context7"
              },
              "github": {
                "type": "remote",
                "url": "https://gateway.goyangi.io/mcp/github"
              },
              "flux": {
                "type": "remote",
                "url": "https://gateway.goyangi.io/mcp/flux"
              },
              "grafana": {
                "type": "remote",
                "url": "https://gateway.goyangi.io/mcp/grafana"
              }
            }
          }
  dataFrom:
    - extract:
        key: kgateway
