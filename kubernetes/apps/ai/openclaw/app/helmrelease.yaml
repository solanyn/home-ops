---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: openclaw
spec:
  chartRef:
    kind: OCIRepository
    name: openclaw
  interval: 1h
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    controllers:
      openclaw:
        annotations:
          reloader.stakater.com/auto: "true"
        initContainers:
          install-tools:
            image:
              repository: ghcr.io/openclaw/openclaw
              tag: 2026.2.17@sha256:1f28ead56a68352c2bbbbd4fb45523a237f271dc3be827b073b9274986a2a829
            command:
              - /bin/sh
              - -c
              - |
                set -e
                mkdir -p /home/node/.local/bin /home/node/.openclaw /home/node/.ssh /home/node/.config/fj

                # Copy config from secret mount (writable copy on PVC)
                cp /tmp/openclaw-config/openclaw.json /home/node/.openclaw/openclaw.json
                chmod 600 /home/node/.openclaw/openclaw.json

                # Setup SSH
                cp /tmp/ssh-secrets/ssh_private_key /home/node/.ssh/forgejo_ed25519
                cp /tmp/ssh-secrets/ssh_config /home/node/.ssh/config
                chmod 700 /home/node/.ssh
                chmod 600 /home/node/.ssh/forgejo_ed25519 /home/node/.ssh/config

                # Setup fj CLI config
                cp /tmp/ssh-secrets/fj_config /home/node/.config/fj/config.toml
                chmod 600 /home/node/.config/fj/config.toml

                # Install fj CLI if not present
                if [ ! -f /home/node/.local/bin/fj ]; then
                  echo "Installing fj CLI..."
                  curl -sL https://codeberg.org/forgejo/fj/releases/latest/download/fj-linux-amd64 -o /home/node/.local/bin/fj
                  chmod +x /home/node/.local/bin/fj
                fi

                # Install uv if not present on PVC
                if [ ! -f /home/node/.local/bin/uv ]; then
                  echo "Installing uv..."
                  cd /tmp
                  curl -fsSL https://astral.sh/uv/install.sh | INSTALLER_NO_MODIFY_PATH=1 UV_INSTALL_DIR=/home/node/.local/bin sh
                fi

                echo "Init container completed successfully"
        containers:
          app:
            image:
              repository: ghcr.io/openclaw/openclaw
              tag: 2026.2.17@sha256:1f28ead56a68352c2bbbbd4fb45523a237f271dc3be827b073b9274986a2a829
            command:
              - /bin/sh
              - -c
              - |
                # Set up openclawbot CLI symlink
                ln -sf /app/openclawbot.mjs /home/node/.local/bin/openclawbot

                # Start gateway
                exec node dist/index.js gateway --bind lan --port 18789 --allow-unconfigured
            env:
              HOME: &homepath /home/node
              TERM: xterm-256color
              PATH: /home/node/.local/bin:/home/node/.local/go/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
              TZ: Australia/Sydney
            envFrom:
              - secretRef:
                  name: openclaw
            resources:
              requests:
                cpu: 10m
                memory: 64Mi

    defaultPodOptions:
      shareProcessNamespace: true
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch
    service:
      app:
        ports:
          http:
            port: 18789
    route:
      app:
        hostnames:
          - openclaw.goyangi.io
        parentRefs:
          - name: envoy-internal
            namespace: network
    rbac:
      roles:
        openclaw-read-all:
          type: ClusterRole
          rules:
            - apiGroups: [""]
              resources: ["pods", "nodes", "services", "namespaces", "configmaps", "persistentvolumes", "persistentvolumeclaims", "endpoints", "resourcequotas", "limitranges", "serviceaccounts"]
              verbs: ["get", "list", "watch"]
            - apiGroups: [""]
              resources: ["pods/log"]
              verbs: ["get", "list"]
            - apiGroups: ["apps"]
              resources: ["deployments", "daemonsets", "statefulsets", "replicasets"]
              verbs: ["get", "list", "watch"]
            - apiGroups: ["batch"]
              resources: ["jobs", "cronjobs"]
              verbs: ["get", "list", "watch"]
            - apiGroups: ["networking.k8s.io"]
              resources: ["ingresses", "networkpolicies"]
              verbs: ["get", "list", "watch"]
            - apiGroups: ["storage.k8s.io"]
              resources: ["storageclasses"]
              verbs: ["get", "list", "watch"]
            - apiGroups: ["rbac.authorization.k8s.io"]
              resources: ["roles", "rolebindings", "clusterroles", "clusterrolebindings"]
              verbs: ["get", "list", "watch"]
            - apiGroups: ["metrics.k8s.io"]
              resources: ["nodes", "pods"]
              verbs: ["get", "list", "watch"]
        openclaw-write-restricted:
          type: Role
          rules:
            - apiGroups: ["apps"]
              resources: ["deployments"]
              verbs: ["patch", "update"]
        openclaw-pod-manage:
          type: ClusterRole
          rules:
            - apiGroups: [""]
              resources: ["pods"]
              verbs: ["delete"]
      bindings:
        openclaw-read-all:
          type: ClusterRoleBinding
          roleRef:
            identifier: openclaw-read-all
          subjects:
            - identifier: openclaw
              serviceAccount: openclaw
        openclaw-write-restricted:
          type: RoleBinding
          roleRef:
            identifier: openclaw-write-restricted
          subjects:
            - identifier: openclaw
              serviceAccount: openclaw
        openclaw-pod-manage:
          type: ClusterRoleBinding
          roleRef:
            identifier: openclaw-pod-manage
          subjects:
            - identifier: openclaw
              serviceAccount: openclaw
    serviceAccount:
      openclaw: {}
    persistence:
      config:
        existingClaim: "{{ .Release.Name }}"
        globalMounts:
          - path: *homepath
      hawow:
        type: nfs
        server: nas.internal
        path: /mnt/world/hawow
        globalMounts:
          - path: /home/node/hawow
      openclaw-config:
        type: secret
        name: openclaw-config
        advancedMounts:
          openclaw:
            install-tools:
              - path: /tmp/openclaw-config
                readOnly: true
      ssh-secrets:
        type: secret
        name: openclaw
        items:
          - key: ssh_private_key
            path: ssh_private_key
          - key: ssh_config
            path: ssh_config
          - key: fj_config
            path: fj_config
        advancedMounts:
          openclaw:
            install-tools:
              - path: /tmp/ssh-secrets
                readOnly: true