---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: openclaw
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: openclaw
    creationPolicy: Owner
    template:
      data:
        OP_SERVICE_ACCOUNT_TOKEN: "{{ .HAWOW_OP_SERVICE_ACCOUNT_TOKEN }}"
        OPENCLAW_GATEWAY_TOKEN: "{{ .OPENCLAW_GATEWAY_TOKEN }}"
        FORGEJO_API_TOKEN: "{{ .OPENCLAW_FORGEJO_API_TOKEN }}"
        ssh_private_key: "{{ .OPENCLAW_SSH_PRIVATE_KEY }}"
        ssh_config: |
          Host forgejo.goyangi.io ssh.forgejo.goyangi.io
            HostName ssh.forgejo.goyangi.io
            User git
            IdentityFile ~/.ssh/forgejo_ed25519
            IdentitiesOnly yes
            StrictHostKeyChecking no
        fj_config: |
          [logins]
            [[logins.list]]
            name = "forgejo"
            url = "https://forgejo.goyangi.io"
            token = "{{ .OPENCLAW_FORGEJO_API_TOKEN }}"
            default = true
            ssh_host = "ssh.forgejo.goyangi.io"
            user = "andrew"
  dataFrom:
    - extract:
        key: 1password
    - extract:
        key: openclaw
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: openclaw-config
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: openclaw-config
    creationPolicy: Owner
    template:
      data:
        openclaw.json: |
          {
            "agents": {
              "list": [
                {
                  "id": "main",
                  "default": true,
                  "name": "Assistant",
                  "workspace": "/home/node/.openclaw/workspace"
                },
                {
                  "id": "coding",
                  "name": "Coder",
                  "workspace": "/home/node/.openclaw/workspace-coding",
                  "model": "gateway/auto-coding",
                  "tools": {
                    "allow": ["read", "write", "edit", "exec", "apply_patch", "browser"]
                  }
                }
              ],
              "defaults": {
                "model": {
                  "primary": "gateway/auto",
                  "fallback": "gateway/mlx-ministral"
                }
              }
            },
            "models": {
              "mode": "merge",
              "providers": {
                "gateway": {
                  "baseUrl": "https://gateway.goyangi.io/v1/auto",
                  "apiKey": "{{ .AGENTGATEWAY_API_KEY }}",
                  "api": "openai-completions",
                  "models": [
                    { "id": "auto", "name": "Auto (failover)" },
                    { "id": "auto-coding", "name": "Auto Coding (failover)" },
                    { "id": "mlx-ministral", "name": "Ministral 8B (local)" }
                  ]
                }
              }
            },
            "gateway": {
              "mode": "local",
              "auth": {
                "mode": "token",
                "token": "{{ .OPENCLAW_GATEWAY_TOKEN }}"
              },
              "trustedProxies": ["10.42.0.0/16", "10.43.0.0/16"]
            },
            "channels": {
              "bluebubbles": {
                "enabled": true,
                "serverUrl": "http://bluebubbles.internal:1234",
                "password": "{{ .BLUEBUBBLES_PASSWORD }}",
                "webhookPath": "/bluebubbles-webhook",
                "dmPolicy": "pairing",
                "groupPolicy": "allowlist",
                "sendReadReceipts": true,
                "actions": {
                  "reactions": true,
                  "edit": true,
                  "unsend": true,
                  "reply": true
                }
              }
            },
            "tools": {
              "web": {
                "search": {
                  "enabled": true,
                  "provider": "brave",
                  "apiKey": "{{ .BRAVE_API_KEY }}"
                }
              },
              "media": {
                "audio": {
                  "enabled": true,
                  "models": [
                    {
                      "provider": "openai",
                      "model": "mlx-community/parakeet-tdt-0.6b-v3",
                      "baseUrl": "https://gateway.goyangi.io/v1"
                    }
                  ]
                }
              }
            }
          }
  dataFrom:
    - extract:
        key: openclaw
    - extract:
        key: kgateway
    - extract:
        key: bluebubbles
    - extract:
        key: brave
