---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: &name openclaw
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: *name
    creationPolicy: Owner
    template:
      data:
        OPENCLAW_GATEWAY_TOKEN: "{{ .OPENCLAW_GATEWAY_TOKEN }}"
        ZAI_API_KEY: "{{ .ZAI_API_KEY }}"
        OPENCLAW_SSH_PRIVATE_KEY: "{{ .OPENCLAW_SSH_PRIVATE_KEY }}"
        OPENCLAW_SSH_PUBLIC_KEY: "{{ .OPENCLAW_SSH_PUBLIC_KEY }}"
  dataFrom:
    - extract:
        key: openclaw
    - extract:
        key: zai
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: &name openclaw-config
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: *name
    creationPolicy: Owner
    template:
      data:
        openclaw.json: |
          {
            "agents": {
              "defaults": {
                "model": {
                   "primary": "zai/glm-4.7"
                 },
                 "models": {
                   "zai/glm-4.7": {
                     "alias": "GLM 4.7"
                   }
                 }
               }
             },
             "models": {
               "mode": "merge",
               "providers": {
                 "zai": {
                   "baseUrl": "https://open.bigmodel.cn/api/paas/v4",
                   "apiKey": "{{ .ZAI_API_KEY }}",
                   "api": "openai-completions",
                   "models": [
                     {
                       "id": "glm-4.7",
                       "name": "GLM 4.7",
                       "reasoning": false,
                       "input": ["text"],
                       "cost": {
                         "input": 0,
                         "output": 0,
                         "cacheRead": 0,
                         "cacheWrite": 0
                       },
                       "contextWindow": 128000,
                       "maxTokens": 4096
                     }
                   ]
                 }
               }
             },
            "gateway": {
              "mode": "local",
              "auth": {
                "mode": "token",
                "token": "{{ .OPENCLAW_GATEWAY_TOKEN }}"
              }
            },
            "channels": {
              "imessage": {
                "enabled": true,
                "cliPath": "/home/node/.local/bin/imsg-ssh",
                "remoteHost": "openclaw@mac.internal",
                "dbPath": "/Users/openclaw/Library/Messages/chat.db"
              }
            }
          }
  dataFrom:
    - extract:
        key: openclaw
    - extract:
        key: zai
