---
apiVersion: agents.x-k8s.io/v1alpha1
kind: Sandbox
metadata:
  name: openclaw
  namespace: ai
spec:
  podTemplate:
    metadata:
      annotations:
        reloader.stakater.com/auto: "true"
    spec:
      serviceAccountName: openclaw
      initContainers:
        - name: fix-permissions
          image: busybox:latest
          command:
            - /bin/sh
            - -c
            - |
              # Create home directory structure with correct permissions
              mkdir -p /home/node/.local/bin
              mkdir -p /home/node/.openclaw
              mkdir -p /home/node/.ssh
              
              # Copy SSH keys from secret to home directory with correct permissions
              # Secrets are mounted as root, so we need to copy them to allow node user access
              cp /tmp/ssh-keys/id_ed25519 /home/node/.ssh/id_ed25519
              cp /tmp/ssh-keys/id_ed25519.pub /home/node/.ssh/id_ed25519.pub
              chmod 600 /home/node/.ssh/id_ed25519
              chmod 644 /home/node/.ssh/id_ed25519.pub
              
              chown -R 1000:100 /home/node
          securityContext:
            runAsUser: 0
            runAsGroup: 0
          volumeMounts:
            - name: config
              mountPath: /home/node
            - name: ssh-key
              mountPath: /tmp/ssh-keys
              readOnly: true
      containers:
        - name: openclaw
          image: ghcr.io/openclaw/openclaw:2026.1.29@sha256:7b67c341d87f8e954dc1e8e9d7bb3aaeaf36acd49594abe4adb826ee89107170
          command:
            - /bin/sh
            - -c
            - |
              # Create local bin directory
              mkdir -p /home/node/.local/bin

              # Set up openclawbot CLI symlink
              ln -sf /app/openclawbot.mjs /home/node/.local/bin/openclawbot

              # Create SSH wrapper script for iMessage
              cat > /home/node/.local/bin/imsg-ssh << 'SCRIPT'
              #!/usr/bin/env bash
              exec ssh -i /home/node/.ssh/id_ed25519 \
                -o BatchMode=yes \
                -o StrictHostKeyChecking=accept-new \
                -o ConnectTimeout=10 \
                -T openclaw@mac.internal \
                "/Users/openclaw/homebrew/bin/imsg" "$@"
              SCRIPT
              chmod +x /home/node/.local/bin/imsg-ssh

              # Create openclaw config with Kimi as default provider
              cat > /home/node/.openclaw/openclaw.json << 'CONFIGEOF'
              {
                "env": {
                  "KIMI_API_KEY": "KIMI_API_KEY_PLACEHOLDER"
                },
                "agents": {
                  "defaults": {
                    "model": {
                      "primary": "kimi-coding/k2p5"
                    },
                    "models": {
                      "kimi-coding/k2p5": {
                        "alias": "Kimi K2.5"
                      }
                    }
                  }
                },
                "models": {
                  "mode": "merge",
                  "providers": {
                    "kimi-coding": {
                      "baseUrl": "https://api.moonshot.cn/v1",
                      "apiKey": "KIMI_API_KEY_PLACEHOLDER",
                      "api": "openai-completions",
                      "models": [
                        {
                          "id": "k2p5",
                          "name": "Kimi K2.5",
                          "reasoning": false,
                          "input": ["text"],
                          "cost": {
                            "input": 0,
                            "output": 0,
                            "cacheRead": 0,
                            "cacheWrite": 0
                          },
                          "contextWindow": 256000,
                          "maxTokens": 8192
                        }
                      ]
                    }
                  }
                },
                "gateway": {
                  "mode": "local",
                  "auth": {
                    "token": "OPENCLAW_GATEWAY_TOKEN_PLACEHOLDER"
                  }
                },
                "browser": {
                  "enabled": true,
                  "headless": true,
                  "noSandbox": true,
                  "defaultProfile": "openclaw"
                },
                "channels": {
                  "imessage": {
                    "enabled": true,
                    "cliPath": "/home/node/.local/bin/imsg-ssh",
                    "remoteHost": "openclaw@mac.internal",
                    "dbPath": "/Users/openclaw/Library/Messages/chat.db"
                  }
                }
              }
              CONFIGEOF
              
              # Substitute environment variables into the config file using sed
              sed -i "s/KIMI_API_KEY_PLACEHOLDER/$(echo "$KIMI_API_KEY" | sed 's/[&/\]/\\&/g')/g" /home/node/.openclaw/openclaw.json
              sed -i "s/OPENCLAW_GATEWAY_TOKEN_PLACEHOLDER/$(echo "$OPENCLAW_GATEWAY_TOKEN" | sed 's/[&/\]/\\&/g')/g" /home/node/.openclaw/openclaw.json

              # Start gateway
              exec node dist/index.js gateway --bind lan --port 18789 --allow-unconfigured
          env:
            - name: HOME
              value: /home/node
            - name: TERM
              value: xterm-256color
            - name: PATH
              value: /home/node/.local/bin:/home/node/.local/go/bin:/home/node/.local/homebrew/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
            - name: GOPATH
              value: /home/node/go
            - name: HOMEBREW_PREFIX
              value: /home/node/.local/homebrew
            - name: HOMEBREW_CELLAR
              value: /home/node/.local/homebrew/Cellar
            - name: HOMEBREW_REPOSITORY
              value: /home/node/.local/homebrew
            - name: TZ
              value: Australia/Sydney
          envFrom:
            - secretRef:
                name: openclaw
          ports:
            - name: http
              containerPort: 18789
          resources:
            requests:
              cpu: 10m
              memory: 64Mi
          securityContext:
            runAsUser: 1000
            runAsGroup: 100
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
          volumeMounts:
            - name: config
              mountPath: /home/node
      volumes:
        - name: config
          persistentVolumeClaim:
            claimName: openclaw
        - name: ssh-key
          secret:
            secretName: openclaw
            items:
              - key: OPENCLAW_SSH_PRIVATE_KEY
                path: id_ed25519
              - key: OPENCLAW_SSH_PUBLIC_KEY
                path: id_ed25519.pub
            defaultMode: 0400
