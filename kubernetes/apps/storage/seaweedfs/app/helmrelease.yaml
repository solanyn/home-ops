# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: seaweedfs
spec:
  interval: 30m
  chartRef:
    kind: OCIRepository
    name: seaweedfs
  values:
    controllers:
      master:
        containers:
          app:
            image:
              repository: chrislusf/seaweedfs
              tag: 3.71
            command:
              - /usr/bin/weed
              - master
              - -defaultReplication=000
              - -ip.bind=0.0.0.0
              - -mdir=/data
              - -metricsPort=9334
            probes:
              liveness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /cluster/status
                    port: 9333
                  initialDelaySeconds: 20
                  timeoutSeconds: 10
                  periodSeconds: 30
                  failureThreshold: 4
              readiness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /cluster/status
                    port: 9333
                  initialDelaySeconds: 10
                  timeoutSeconds: 10
                  periodSeconds: 45
                  failureThreshold: 100
      volume:
        containers:
          app:
            image:
              repository: chrislusf/seaweedfs
              tag: 3.71
            command:
              - /usr/bin/weed
              - volume
              - -mserver=seaweedfs-master:9333
              - -dir=/data
              - -ip.bind=0.0.0.0
              - -max=100
              - -metricsPort=8081
            probes:
              liveness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /healthz
                    port: 8080
                  initialDelaySeconds: 20
                  timeoutSeconds: 30
                  periodSeconds: 90
                  failureThreshold: 4
              readiness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /healthz
                    port: 8080
                  initialDelaySeconds: 15
                  timeoutSeconds: 30
                  periodSeconds: 15
                  failureThreshold: 100
            securityContext:
              runAsUser: 1000
              runAsGroup: 1000
              fsGroup: 1000
      filer:
        containers:
          app:
            image:
              repository: chrislusf/seaweedfs
              tag: 3.71
            command:
              - /usr/bin/weed
              - filer
              - -master=seaweedfs-master:9333
              - -ip.bind=0.0.0.0
              - -defaultStoreDir=/data
              - -metricsPort=8889
            probes:
              liveness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /
                    port: 8888
                  initialDelaySeconds: 20
                  timeoutSeconds: 10
                  periodSeconds: 30
                  failureThreshold: 5
              readiness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /
                    port: 8888
                  initialDelaySeconds: 10
                  timeoutSeconds: 10
                  periodSeconds: 15
                  failureThreshold: 100
      s3:
        containers:
          app:
            image:
              repository: chrislusf/seaweedfs
              tag: 3.71
            command:
              - /usr/bin/weed
              - s3
              - -filer=seaweedfs-filer:8888
              - -ip.bind=0.0.0.0
              - -metricsPort=8334
            env:
              - name: WEED_FILER_OPTIONS_RECURSIVE_DELETE
                value: "false"
            probes:
              liveness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /status
                    port: 8333
                  initialDelaySeconds: 20
                  timeoutSeconds: 10
                  periodSeconds: 60
                  failureThreshold: 20
              readiness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /status
                    port: 8333
                  initialDelaySeconds: 15
                  timeoutSeconds: 10
                  periodSeconds: 15
                  failureThreshold: 100
    service:
      master:
        controller: master
        ports:
          http:
            port: 9333
          grpc:
            port: 19333
          metrics:
            port: 9334
      volume:
        controller: volume
        ports:
          http:
            port: 8080
          grpc:
            port: 18080
          metrics:
            port: 8081
      filer:
        controller: filer
        ports:
          http:
            port: 8888
          grpc:
            port: 18888
          metrics:
            port: 8889
      s3:
        controller: s3
        ports:
          http:
            port: 8333
          metrics:
            port: 8334
    serviceMonitor:
      master:
        enabled: true
        serviceName: seaweedfs-master
        endpoints:
          - port: metrics
            scheme: http
      volume:
        enabled: true
        serviceName: seaweedfs-volume
        endpoints:
          - port: metrics
            scheme: http
      filer:
        enabled: true
        serviceName: seaweedfs-filer
        endpoints:
          - port: metrics
            scheme: http
      s3:
        enabled: true
        serviceName: seaweedfs-s3
        endpoints:
          - port: metrics
            scheme: http
    route:
      filer:
        hostnames: ["{{ .Release.Name }}.goyangi.io"]
        parentRefs:
          - name: envoy-internal
            namespace: network
            sectionName: https
        rules:
          - backendRefs:
              - name: seaweedfs-filer
                port: 8888
    persistence:
      config:
        existingClaim: seaweedfs
        advancedMounts:
          master:
            app:
              - path: /data
                subPath: master
          filer:
            app:
              - path: /data
                subPath: filer
      data:
        type: nfs
        server: nas.internal
        path: /mnt/world/seaweedfs
        advancedMounts:
          volume:
            app:
              - path: /data
