---
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: postgres
  annotations:
    cnpg.io/skipEmptyWalArchiveCheck: "enabled"
spec:
  instances: 3
  imageName: ghcr.io/cloudnative-pg/postgresql:18.1-standard-trixie@sha256:4dce4eeb92bd3d16d0c1131838ce3586a16fdc4763d30423a00253968bfd3f9d
  primaryUpdateStrategy: unsupervised
  storage:
    size: 20Gi
    storageClass: openebs-hostpath
  superuserSecret:
    name: cloudnative-pg-secret
  enableSuperuserAccess: true
  certificates:
    serverCASecret: postgres-server-cert
    serverTLSSecret: postgres-server-cert
    clientCASecret: postgres-client-ca
    replicationTLSSecret: postgres-replication-cert
  postgresql:
    shared_preload_libraries:
      - "vchord.so"
    parameters:
      max_connections: "200"
      shared_buffers: 256MB
    pg_hba:
      - hostnossl all all 10.42.0.0/16 scram-sha-256
      - hostssl all all all cert clientcert=verify-full
    extensions:
      - name: postgis
        ld_library_path:
          - system
        image:
          reference: ghcr.io/cloudnative-pg/postgis-extension-testing:3.6.0-18-trixie@sha256:ec21540f5799561a9b05ca188fd28ce32852a826f48d80329260940855f5f558
      - name: vchord
        image:
          reference: ghcr.io/tensorchord/vchord-scratch:pg18-v0.5.3@sha256:c310ede47f7f82bd257c3e53806d60680d5899c318ca946fb313efad9a90a78e
        dynamic_library_path:
          - /usr/lib/postgresql/18/lib
        extension_control_path:
          - /usr/share/postgresql/18/
  managed:
    # TODO: Database CRD should create roles automatically
    # https://github.com/cloudnative-pg/cloudnative-pg/issues/5341
    roles:
      - name: authentik
        ensure: present
        login: true
        disablePassword: true
      - name: atuin
        ensure: present
        login: true
        disablePassword: true
      - name: mealie
        ensure: present
        login: true
        disablePassword: true
      - name: immich
        ensure: present
        login: true
        disablePassword: true
      - name: mlflow
        ensure: present
        login: true
        disablePassword: true
      - name: prowlarr
        ensure: present
        login: true
      - name: radarr
        ensure: present
        login: true
      - name: autobrr
        ensure: present
        login: true
        disablePassword: true
      - name: label-studio
        ensure: present
        login: true
      - name: romm
        ensure: present
        login: true
        disablePassword: true
      - name: lidarr
        ensure: present
        login: true
      - name: seerr
        ensure: present
        login: true
        disablePassword: true
      - name: whisparr
        ensure: present
        login: true
      - name: sonarr
        ensure: present
        login: true
      - name: gitlab
        ensure: present
        login: true
        passwordSecret:
          name: gitlab-postgres
  resources:
    requests:
      cpu: 10m
    limits:
      hugepages-2Mi: 1Gi
      memory: 4Gi
  monitoring:
    enablePodMonitor: true
  plugins:
    - name: barman-cloud.cloudnative-pg.io
      isWALArchiver: true
      parameters: &parameters
        barmanObjectName: garage
        serverName: postgres18-v1
  bootstrap:
    recovery:
      source: source
  externalClusters:
    - name: source
      plugin:
        name: barman-cloud.cloudnative-pg.io
        parameters:
          barmanObjectName: garage
          serverName: postgres18-v1
