apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: trino
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: trino-secret
    template:
      data:
        values.yaml: |
          server:
            exchangeManager:
              name: filesystem
              base-directories: s3://trino
              s3:
                aws-access-key: "{{ .MINIO_ROOT_USER }}"
                aws-secret-key: "{{ .MINIO_ROOT_PASSWORD }}"
                endpoint: http://minio.default.svc.cluster.local:9000
          coordinatorExtraConfig: |
            discovery-server.enabled=true
            http-server.process-forwarded=true
            http-server.authentication.oauth2.scopes="openid profile email"
            http-server.authentication.oauth2.issuer="https://id.goyangi.cloud"
            http-server.authentication.oauth2.client-id="{{ .TRINO_CLIENT_ID }}"
            http-server.authentication.oauth2.client-secret="{{ .TRINO_CLIENT_SECRET }}"
  dataFrom:
    - extract:
        key: trino
    - extract:
        key: minio
