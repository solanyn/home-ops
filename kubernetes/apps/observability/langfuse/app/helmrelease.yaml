---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: langfuse
spec:
  chart:
    spec:
      chart: langfuse
      version: 1.2.16
      sourceRef:
        kind: HelmRepository
        name: langfuse
  interval: 1h
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    langfuse:
      extraInitContainers:
        - name: init-db
          image: ghcr.io/home-operations/postgres-init:18
          envFrom:
            - secretRef:
                name: langfuse-secret
      extraEnv:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: langfuse-secret
              key: DATABASE_URL
        - name: NEXTAUTH_SECRET
          valueFrom:
            secretKeyRef:
              name: langfuse-secret
              key: NEXTAUTH_SECRET
        - name: SALT
          valueFrom:
            secretKeyRef:
              name: langfuse-secret
              key: SALT
        - name: ENCRYPTION_KEY
          valueFrom:
            secretKeyRef:
              name: langfuse-secret
              key: ENCRYPTION_KEY
        - name: CLICKHOUSE_MIGRATION_URL
          valueFrom:
            secretKeyRef:
              name: langfuse-secret
              key: CLICKHOUSE_URL
        - name: CLICKHOUSE_URL
          valueFrom:
            secretKeyRef:
              name: langfuse-secret
              key: CLICKHOUSE_URL
        - name: CLICKHOUSE_USER
          valueFrom:
            secretKeyRef:
              name: langfuse-secret
              key: CLICKHOUSE_USER
        - name: CLICKHOUSE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: langfuse-secret
              key: CLICKHOUSE_PASSWORD
        - name: REDIS_HOST
          valueFrom:
            secretKeyRef:
              name: langfuse-secret
              key: REDIS_HOST
        - name: REDIS_PORT
          valueFrom:
            secretKeyRef:
              name: langfuse-secret
              key: REDIS_PORT
        - name: REDIS_AUTH
          valueFrom:
            secretKeyRef:
              name: langfuse-secret
              key: REDIS_AUTH
        - name: LANGFUSE_S3_EVENT_UPLOAD_BUCKET
          valueFrom:
            secretKeyRef:
              name: langfuse-secret
              key: S3_BUCKET_NAME
        - name: LANGFUSE_S3_EVENT_UPLOAD_REGION
          valueFrom:
            secretKeyRef:
              name: langfuse-secret
              key: S3_REGION
        - name: LANGFUSE_S3_EVENT_UPLOAD_ENDPOINT
          valueFrom:
            secretKeyRef:
              name: langfuse-secret
              key: S3_ENDPOINT
        - name: LANGFUSE_S3_EVENT_UPLOAD_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              name: langfuse-secret
              key: S3_ACCESS_KEY_ID
        - name: LANGFUSE_S3_EVENT_UPLOAD_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: langfuse-secret
              key: S3_SECRET_ACCESS_KEY
        - name: LANGFUSE_S3_EVENT_UPLOAD_FORCE_PATH_STYLE
          value: "true"
        - name: NEXTAUTH_URL
          value: https://langfuse.goyangi.io
        - name: AUTH_CUSTOM_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: langfuse-secret
              key: AUTH_CUSTOM_CLIENT_ID
        - name: AUTH_CUSTOM_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: langfuse-secret
              key: AUTH_CUSTOM_CLIENT_SECRET
        - name: AUTH_CUSTOM_ISSUER
          value: https://id.goyangi.io
        - name: AUTH_CUSTOM_NAME
          value: Pocket ID
        - name: AUTH_DISABLE_USERNAME_PASSWORD
          value: "true"
      service:
        type: ClusterIP
        port: 3000
    ingress:
      enabled: false
    postgresql:
      enabled: false
    clickhouse:
      enabled: false
    redis:
      enabled: false
