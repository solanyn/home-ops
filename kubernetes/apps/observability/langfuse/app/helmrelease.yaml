---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: langfuse
spec:
  chart:
    spec:
      chart: langfuse
      version: 1.5.19
      sourceRef:
        kind: HelmRepository
        name: langfuse
  interval: 1h
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    langfuse:
      salt:
        secretKeyRef:
          name: langfuse-secret
          key: SALT
      nextauth:
        secret:
          secretKeyRef:
            name: langfuse-secret
            key: NEXTAUTH_SECRET
      encryptionKey:
        secretKeyRef:
          name: langfuse-secret
          key: ENCRYPTION_KEY
      extraInitContainers:
        - name: init-db
          image: ghcr.io/home-operations/postgres-init:18
          envFrom:
            - secretRef:
                name: langfuse-secret
      additionalEnv:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: langfuse-secret
              key: DATABASE_URL
        - name: CLICKHOUSE_MIGRATION_URL
          valueFrom:
            secretKeyRef:
              name: langfuse-secret
              key: CLICKHOUSE_URL
        - name: CLICKHOUSE_URL
          valueFrom:
            secretKeyRef:
              name: langfuse-secret
              key: CLICKHOUSE_URL
        - name: CLICKHOUSE_USER
          valueFrom:
            secretKeyRef:
              name: langfuse-secret
              key: CLICKHOUSE_USER
        - name: CLICKHOUSE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: langfuse-secret
              key: CLICKHOUSE_PASSWORD
        - name: NEXTAUTH_URL
          value: https://langfuse.goyangi.io
        - name: AUTH_CUSTOM_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: langfuse-secret
              key: AUTH_CUSTOM_CLIENT_ID
        - name: AUTH_CUSTOM_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: langfuse-secret
              key: AUTH_CUSTOM_CLIENT_SECRET
        - name: AUTH_CUSTOM_ISSUER
          value: https://id.goyangi.io
        - name: AUTH_CUSTOM_NAME
          value: Pocket ID
        - name: AUTH_DISABLE_USERNAME_PASSWORD
          value: "true"
      service:
        type: ClusterIP
        port: 3000
    ingress:
      enabled: false
    postgresql:
      deploy: false
    clickhouse:
      deploy: false
    redis:
      deploy: false
      host: dragonfly-cluster.storage.svc.cluster.local
      port: 6379
      auth:
        password:
          secretKeyRef:
            name: langfuse-secret
            key: REDIS_AUTH
    s3:
      deploy: false
      bucket: langfuse
      region: garage
      endpoint: http://garage.storage.svc.cluster.local:3900
      forcePathStyle: true
      accessKeyId:
        secretKeyRef:
          name: langfuse-secret
          key: S3_ACCESS_KEY_ID
      secretAccessKey:
        secretKeyRef:
          name: langfuse-secret
          key: S3_SECRET_ACCESS_KEY
      eventUpload:
        prefix: events/
      batchExport:
        prefix: exports/
      mediaUpload:
        prefix: media/
