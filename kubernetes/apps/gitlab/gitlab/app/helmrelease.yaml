---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: gitlab
spec:
  chart:
    spec:
      chart: gitlab
      version: 9.7.0
      sourceRef:
        kind: HelmRepository
        name: gitlab
  interval: 1h
  values:
    global:
      edition: ce
      time_zone: Australia/Sydney
      hosts:
        domain: goyangi.io
        https: true
        gitlab:
          name: gitlab.goyangi.io
        registry:
          name: gitlab-registry.goyangi.io
        minio:
          name: minio.gitlab.goyangi.io
      ingress:
        enabled: false
      certmanager:
        install: false
    certmanager-issuer:
      email: false
      psql:
        host: postgres-rw.storage.svc.cluster.local
        database: gitlab
        username: gitlab
        password:
          useSecret: false
        ssl:
          secret: postgres-gitlab-cert
          serverCA: ca.crt
          clientCertificate: tls.crt
          clientKey: tls.key
      redis:
        host: dragonfly.storage.svc.cluster.local
        auth:
          enabled: false
      email:
        display_name: GitLab
        from: noreply@goyangi.io
        reply_to: noreply@goyangi.io
      smtp:
        enabled: true
        address: smtp-relay.network.svc.cluster.local
        port: 25
        domain: goyangi.io
        authentication: none
        starttls_auto: false
      initialRootPassword:
        secret: gitlab-secret
        key: GITLAB_ROOT_PASSWORD
      minio:
        enabled: false
      appConfig:
        omniauth:
          enabled: true
          autoSignInWithProvider: []
          syncProfileFromProvider: [openid_connect]
          allowSingleSignOn: [openid_connect]
          allowBypassTwoFactor: [openid_connect]
          syncProfileAttributes: [email]
          blockAutoCreatedUsers: false
          providers:
            - secret: gitlab-secret
              key: oidc-config
        object_store:
          enabled: true
          proxy_download: true
          storage_options: {}
          connection:
            secret: gitlab-secret
            key: s3-config
        lfs:
          enabled: true
          proxy_download: true
          bucket: gitlab
          connection: {}
        artifacts:
          enabled: true
          proxy_download: true
          bucket: gitlab
          connection: {}
        uploads:
          enabled: true
          proxy_download: true
          bucket: gitlab
          connection: {}
        packages:
          enabled: true
          proxy_download: true
          bucket: gitlab
          connection: {}
        backups:
          bucket: gitlab
          tmpdir: /tmp
    postgresql:
      install: false
    redis:
      install: false
    minio:
      install: false
    gitlab:
      webservice:
        minReplicas: 1
        maxReplicas: 1
        resources:
          requests:
            cpu: 10m
            memory: 64Mi
          limits:
            memory: 2Gi
      gitaly:
        persistence:
          enabled: true
          existingClaim: "{{ .Release.Name }}"
          size: 50Gi
        resources:
          requests:
            cpu: 10m
            memory: 64Mi
          limits:
            memory: 512Mi
      sidekiq:
        minReplicas: 1
        maxReplicas: 1
        containers:
          app:
            envFrom:
              - secretRef:
                  name: gitlab-secret
        resources:
          requests:
            cpu: 10m
            memory: 64Mi
          limits:
            memory: 1Gi
      gitlab-shell:
        enabled: false
      gitlab-pages:
        resources:
          requests:
            cpu: 10m
            memory: 10Mi
          limits:
            memory: 64Mi
      kas:
        minReplicas: 1
        maxReplicas: 1
    registry:
      enabled: true
      hpa:
        minReplicas: 1
        maxReplicas: 1
      storage:
        secret: gitlab-secret
        key: registry-config
    nginx-ingress:
      enabled: false
    prometheus:
      install: false
    grafana:
      enabled: false
    gitlab-runner:
      install: false
