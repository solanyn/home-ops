---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: "{{ .Release.Name }}"
spec:
  chartRef:
    kind: OCIRepository
    name: gitlab
  interval: 1h
  timeout: 30m
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    global:
      edition: ce
      time_zone: Australia/Sydney
      
      hosts:
        domain: goyangi.io
        https: true
        gitlab:
          name: gitlab.goyangi.io
        registry:
          name: registry.gitlab.goyangi.io
        minio:
          name: minio.gitlab.goyangi.io
      
      ingress:
        class: envoy-internal
        configureCertmanager: false
        tls:
          enabled: false
      
      # External PostgreSQL
      psql:
        host: postgres-rw.storage.svc.cluster.local
        database: gitlab
        username: gitlab
        password:
          useSecret: true
          secret: gitlab-secret
          key: POSTGRES_PASSWORD
      
      # External Redis
      redis:
        host: dragonfly.storage.svc.cluster.local
        auth:
          enabled: true
          secret: gitlab-secret
          key: REDIS_PASSWORD
      
      # Email configuration
      email:
        display_name: GitLab
        from: gitlab@goyangi.io
        reply_to: noreply@goyangi.io
      
      smtp:
        enabled: true
        address: "{{ .SMTP_HOST }}"
        port: 587
        user_name: "{{ .SMTP_USER }}"
        password:
          secret: gitlab-secret
          key: SMTP_PASSWORD
        domain: goyangi.io
        starttls_auto: true
      
      # Initial root password
      initialRootPassword:
        secret: gitlab-secret
        key: GITLAB_ROOT_PASSWORD
      
      # Object storage (Garage)
      minio:
        enabled: false
      
      appConfig:
        object_store:
          enabled: true
          proxy_download: true
          storage_options: {}
          connection:
            secret: gitlab-secret
            key: s3-config
        
        lfs:
          enabled: true
          proxy_download: true
          bucket: gitlab-lfs
          connection: {}
        
        artifacts:
          enabled: true
          proxy_download: true
          bucket: gitlab-artifacts
          connection: {}
        
        uploads:
          enabled: true
          proxy_download: true
          bucket: gitlab-uploads
          connection: {}
        
        packages:
          enabled: true
          proxy_download: true
          bucket: gitlab-packages
          connection: {}
        
        backups:
          bucket: gitlab-backups
          tmpdir: /tmp
    
    # Disable built-in services
    postgresql:
      install: false
    
    redis:
      install: false
    
    minio:
      install: false
    
    # GitLab components
    gitlab:
      gitaly:
        persistence:
          enabled: true
          existingClaim: "{{ .Release.Name }}"
          size: 50Gi
        resources:
          requests:
            cpu: 100m
            memory: 1Gi
          limits:
            memory: 2Gi
      
      webservice:
        minReplicas: 1
        maxReplicas: 1
        resources:
          requests:
            cpu: 200m
            memory: 2Gi
          limits:
            memory: 4Gi
      
      sidekiq:
        minReplicas: 1
        maxReplicas: 1
        resources:
          requests:
            cpu: 100m
            memory: 1Gi
          limits:
            memory: 2Gi
      
      gitlab-shell:
        minReplicas: 1
        maxReplicas: 1
        resources:
          requests:
            cpu: 50m
            memory: 256Mi
          limits:
            memory: 512Mi
    
    # Container registry
    registry:
      enabled: true
      storage:
        secret: gitlab-secret
        key: registry-config
    
    # Disable optional components
    certmanager:
      install: false
    
    nginx-ingress:
      enabled: false
    
    prometheus:
      install: false
    
    grafana:
      enabled: false
    
    gitlab-runner:
      install: false
