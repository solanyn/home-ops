---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: "{{ .Release.Name }}"
spec:
  chartRef:
    kind: OCIRepository
    name: gitlab
  interval: 1h
  timeout: 30m
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    global:
      edition: ce
      time_zone: Australia/Sydney
      
      hosts:
        domain: goyangi.io
        https: true
        gitlab:
          name: gitlab.goyangi.io
        registry:
          name: registry.gitlab.goyangi.io
        minio:
          name: minio.gitlab.goyangi.io
      
      ingress:
        class: envoy-internal
        configureCertmanager: false
        tls:
          enabled: false
      
      # External PostgreSQL
      psql:
        host: postgres-rw.storage.svc.cluster.local
        database: gitlab
        username: gitlab
        password:
          useSecret: true
          secret: gitlab-secret
          key: POSTGRES_PASSWORD
      
      # External Redis
      redis:
        host: dragonfly.storage.svc.cluster.local
        auth:
          enabled: true
          secret: gitlab-secret
          key: REDIS_PASSWORD
      
      # Email configuration
      email:
        display_name: GitLab
        from: noreply@goyangi.io
        reply_to: noreply@goyangi.io
      
      smtp:
        enabled: true
        address: smtp-relay.network.svc.cluster.local
        port: 25
        domain: goyangi.io
        authentication: none
        starttls_auto: false
      
      # Initial root password
      initialRootPassword:
        secret: gitlab-secret
        key: GITLAB_ROOT_PASSWORD
      
      # Object storage (Garage)
      minio:
        enabled: false
      
      appConfig:
        omniauth:
          enabled: true
          autoSignInWithProvider: []
          syncProfileFromProvider: [openid_connect]
          allowSingleSignOn: [openid_connect]
          allowBypassTwoFactor: [openid_connect]
          syncProfileAttributes: [email]
          blockAutoCreatedUsers: false
          providers:
            - secret: gitlab-secret
              key: oidc-config
        
        object_store:
          enabled: true
          proxy_download: true
          storage_options: {}
          connection:
            secret: gitlab-secret
            key: s3-config
        
        lfs:
          enabled: true
          proxy_download: true
          bucket: gitlab
          connection: {}
        
        artifacts:
          enabled: true
          proxy_download: true
          bucket: gitlab
          connection: {}
        
        uploads:
          enabled: true
          proxy_download: true
          bucket: gitlab
          connection: {}
        
        packages:
          enabled: true
          proxy_download: true
          bucket: gitlab
          connection: {}
        
        backups:
          bucket: gitlab
          tmpdir: /tmp
    
    # Disable built-in services
    postgresql:
      install: false
    
    redis:
      install: false
    
    minio:
      install: false
    
    # GitLab components
    gitlab:
      webservice:
        initContainers:
          init-db:
            image:
              repository: ghcr.io/home-operations/postgres-init
              tag: 18@sha256:866f15038ed5185a2b8118821f470bb7ca0df8c4231b8e277446e681ebb1ed84
            envFrom: &envFrom
              - secretRef:
                  name: gitlab-secret
        minReplicas: 1
        maxReplicas: 1
        resources:
          requests:
            cpu: 10m
            memory: 64Mi
          limits:
            memory: 2Gi
      
      gitaly:
        persistence:
          enabled: true
          existingClaim: "{{ .Release.Name }}"
          size: 50Gi
        resources:
          requests:
            cpu: 10m
            memory: 64Mi
          limits:
            memory: 512Mi
      
      webservice:
        minReplicas: 1
        maxReplicas: 1
        resources:
          requests:
            cpu: 10m
            memory: 64Mi
          limits:
            memory: 2Gi
      
      sidekiq:
        minReplicas: 1
        maxReplicas: 1
        containers:
          app:
            envFrom: *envFrom
        resources:
          requests:
            cpu: 10m
            memory: 64Mi
          limits:
            memory: 1Gi
      
      gitlab-shell:
        minReplicas: 1
        maxReplicas: 1
        resources:
          requests:
            cpu: 10m
            memory: 64Mi
          limits:
            memory: 128Mi
      
      gitlab-pages:
        resources:
          requests:
            cpu: 10m
            memory: 10Mi
          limits:
            memory: 64Mi
    
    # Container registry
    registry:
      enabled: true
      storage:
        secret: gitlab-secret
        key: registry-config
    
    # Disable optional components
    certmanager:
      install: false
    
    nginx-ingress:
      enabled: false
    
    prometheus:
      install: false
    
    grafana:
      enabled: false
    
    gitlab-runner:
      install: false
