# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1beta1.json
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: jupyter
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: jupyter-secret
    template:
      data:
        values.yaml: |
          singleuser:
            defaultUrl: "/lab"
            extraEnv:
              JUPYTERHUB_SINGLEUSER_APP: "jupyter_server.serverapp.ServerApp"
            memory:
              limit: 16G
          fullnameOverride: jupyter
          hub:
            config:
              JupyterHub:
                admin_access: true
                admin_users:
                  - andrew
                authenticator_class: generic-oauth
              KubeSpawner:
                k8s_api_request_timeout: 10
              GenericOAuthenticator:
                client_id: "{{ .JUPYTER_CLIENT_ID }}"
                client_secret: "{{ .JUPYTER_CLIENT_SECRET }}"
                oauth_callback_url: https://jupyter.goyangi.cloud/hub/oauth_callback
                authorize_url: https://id.goyangi.cloud/authorize
                token_url: https://id.goyangi.cloud/api/oidc/token
                userdata_url: https://id.goyangi.cloud/api/oidc/userinfo
                login_service: Pocket ID
                username_claim: "email"
                userdata_params:
                  state: state
                allow_all: true
                admin_users:
                  - admin
            db:
              type: postgres
              url: "postgresql+psycopg2://{{.JUPYTER_POSTGRES_USER}}:{{.JUPYTER_POSTGRES_PASS}}@postgres16-rw.database.svc.cluster.local:5432/jupyter"
              password: "{{.JUPYTER_POSTGRES_PASS}}"
            initContainers:
              - name: init-db
                image: ghcr.io/solanyn/postgres-init:16
                env:
                  - name: INIT_POSTGRES_DBNAME
                    value: jupyter
                  - name: INIT_POSTGRES_HOST
                    value: postgres16-rw.database.svc.cluster.local
                  - name: INIT_POSTGRES_USER
                    value: "{{ .JUPYTER_POSTGRES_USER }}"
                  - name: INIT_POSTGRES_PASS
                    value: "{{ .JUPYTER_POSTGRES_PASS }}"
                  - name: INIT_POSTGRES_SUPER_PASS
                    value: "{{ .POSTGRES_SUPER_PASS }}"
            resources:
              requests:
                cpu: 10m
                memory: 256Mi
          ingress:
            enabled: true
            ingressClassName: internal
            hosts: ["jupyter.goyangi.cloud"]
          cull:
            enabled: true
            users: true
            adminUsers: true
          singleuser:
            cpu:
              limit: 4
              guarantee: 0.05
            memory:
              limit: 16G
              guarantee: 128Mi
  dataFrom:
    - extract:
        key: jupyter
    - extract:
        key: cloudnative-pg
