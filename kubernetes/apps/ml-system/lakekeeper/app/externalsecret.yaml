# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1beta1.json
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: lakekeeper
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: lakekeeper-secret
    template:
      data:
        LAKEKEEPER__PG_ENCRYPTION_KEY: "{{ .LAKEKEEPER_ENCRYPTION_KEY }}"
        LAKEKEEPER__PG_HOST_R: postgres16-r.database.svc.cluster.local
        LAKEKEEPER__PG_HOST_W: postgres16-rw.database.svc.cluster.local
        LAKEKEEPER__PG_USER: "{{ .LAKEKEEPER_POSTGRES_USER }}"
        LAKEKEEPER__PG_PASSWORD: "{{ .LAKEKEEPER_POSTGRES_PASSWORD }}"
        LAKEKEEPER__PG_DATABASE: lakekeeper
        LAKEKEEPER__PG_SSL_MODE: disable
        LAKEKEEPER__OPENID_PROVIDER_URI: https://id.goyangi.cloud
        LAKEKEEPER__AUTHZ_BACKEND: allowall
        LAKEKEEPER__UI__OPENID_CLIENT_ID: "{{ .LAKEKEEPER_OIDC_CLIENT_ID }}"
        values.yaml: |
          fullnameOverride: lakekeeper
          catalog:
            resources:
              requests:
                cpu: 10m
                memory: 128Mi
            config:
              LAKEKEEPER__BASE_URI: https://lakekeeper.goyangi.cloud
            extraInitContainers:
              - name: init-db
                image: ghcr.io/solanyn/postgres-init:16
                env:
                  - name: INIT_POSTGRES_DBNAME
                    value: "lakekeeper"
                  - name: INIT_POSTGRES_HOST
                    value: "postgres16-rw.database.svc.cluster.local"
                  - name: INIT_POSTGRES_USER
                    value: "{{ .LAKEKEEPER_POSTGRES_USER }}"
                  - name: INIT_POSTGRES_PASS
                    value: "{{ .LAKEKEEPER_POSTGRES_PASSWORD }}"
                  - name: INIT_POSTGRES_SUPER_PASS
                    value: "{{ .POSTGRES_SUPER_PASS }}"
                  - name: INIT_POSTGRES_SUPER_USER
                    value: "{{ .POSTGRES_SUPER_USER }}"
          ingress:
            enabled: true
            annotations:
              nginx.ingress.kubernetes.io/rewrite-target: /
            host: lakekeeper.goyangi.cloud
            ingressClassName: internal
          secretBackend:
            postgres:
              encryptionKeySecret: lakekeeper-secret
              encyptionKeySecretKey: LAKEKEEPER__PG_ENCRYPTION_KEY
          postgresql:
            enabled: false
          externalDatabase:
            host_read: postgres16-w.database.svc.cluster.local
            host_write: postgres16-rw.database.svc.cluster.local
            database: lakekeeper
            userSecret: &secret lakekeeper-secret
            userSecretKey: LAKEKEEPER__PG_USER
            passwordSecret: *secret
            passwordSecretKey: LAKEKEEPER__PG_PASSWORD
          auth:
            oauth2:
              providerUri: https://id.goyangi.cloud
            ui:
              clientID: "{{ .LAKEKEEPER_OIDC_CLIENT_ID }}"
  dataFrom:
    - extract:
        key: cloudnative-pg
    - extract:
        key: lakekeeper
