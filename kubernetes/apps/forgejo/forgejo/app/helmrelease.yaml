apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: forgejo
  namespace: forgejo
spec:
  interval: 30m
  chart:
    spec:
      chart: forgejo
      version: "5.x"
      sourceRef:
        kind: HelmRepository
        name: forgejo
        namespace: forgejo
  values:
    replicaCount: 1

    image:
      repository: codeberg.org/forgejo/forgejo
      tag: latest
      pullPolicy: IfNotPresent

    service:
      http:
        type: ClusterIP
        port: 3000
      ssh:
        type: LoadBalancer
        port: 22
        externalIPs:
          - 192.168.222.125

    ingress:
      enabled: false

    forgejo:
      admin:
        existingSecret: forgejo-secret
        username: admin
      server:
        HTTP_ADDR: "0.0.0.0"
        HTTP_PORT: 3000
        ROOT_URL: "https://forgejo.${SECRET_DOMAIN_INTERNAL}/"
        DOMAIN: "forgejo.${SECRET_DOMAIN_INTERNAL}"
        SSH_DOMAIN: "ssh.forgejo.${SECRET_DOMAIN_INTERNAL}"
        SSH_PORT: 22
        SSH_LISTEN_HOST: "0.0.0.0"
        SSH_LISTEN_PORT: 22
        LANDING_PAGE: "explore"
        ENABLE_PUSH_CREATE_USER: "false"
        ENABLE_PUSH_CREATE_ORG: "false"

      database:
        DB_TYPE: "postgres"
        HOST: "postgres-rw.storage.svc.cluster.local:5432"
        NAME: "forgejo"
        USER: "forgejo"
        PASSWD: ""
        SSL_MODE: "disable"

      cache:
        ADAPTER: "redis"
        HOST: "dragonfly.storage.svc.cluster.local:6379"
        DB: "0"

      queue:
        TYPE: "redis"
        CONN_STR: ""

      session:
        PROVIDER: "redis"
        PROVIDER_CONFIG: "dragonfly.storage.svc.cluster.local:6379/1"

      indexer:
        ISSUE_INDEXER_TYPE: "db"

      storage:
        STORAGE_TYPE: "s3"
        S3_ENDPOINT: "garage.storage.svc.cluster.local:3900"
        S3_ACCESS_KEY_ID: ""
        S3_SECRET_ACCESS_KEY: ""
        S3_BUCKET: "forgejo"
        S3_REGION: "garage"
        S3_PATH_PREFIX: ""
        S3_USE_PATH_STYLE: "true"
        S3_SKIP_TLS_VERIFY: "true"

      oauth2:
        ENABLED: "true"

      openid:
        ENABLE_OPENID_SIGNIN: "true"
        ENABLE_OPENID_SIGNUP: "true"
        WHITELISTED_URIS: ""
        BLACKLISTED_URIS: ""

      auth:
        AUTH_ACTIVE_REG_EMAIL_CONFIRMATION: "false"
        AUTH_REQUIRE_EMAIL_CONFIRMATION: "false"
        AUTH_DISABLE_REGISTRATION: "true"

      service:
        ACTIVE_CODE_LIVE_MINUTES: "180"
        RESET_PASSWD_CODE_LIVE_MINUTES: "180"
        REGISTER_EMAIL_CONFIRM: "false"
        ENABLE_NOTIFY_MAIL: "false"
        ALLOW_ONLY_INTERNAL_REGISTRATION: "false"

      mailer:
        ENABLED: "true"
        PROTOCOL: "smtp"
        SMTP_ADDR: "smtp-relay.network.svc.cluster.local"
        SMTP_PORT: "25"
        FROM: "noreply@${SECRET_DOMAIN}"
        USER: ""
        PASSWD: ""

    postgresql:
      enabled: false

    redis:
      enabled: false

    gitea:
      enabled: false

    memcached:
      enabled: false

    persistence:
      enabled: true
      size: 10Gi
      storageClassName: ceph-block
      mount: /data

    securityContext:
      capabilities:
        add:
          - SYS_CHROOT

    metrics:
      enabled: true
      serviceMonitor:
        enabled: true
        namespace: forgejo
