---
apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: gke-cluster-with-liqo
  labels:
    provider: gcp
spec:
  compositeTypeRef:
    apiVersion: home-ops.io/v1alpha1
    kind: XGKECluster
  resources:
    - name: gke-cluster
      base:
        apiVersion: container.gcp.upbound.io/v1beta1
        kind: Cluster
        spec:
          forProvider:
            location: "australia-southeast1"
            initialNodeCount: 1
            removeDefaultNodePool: true
            # Minimal addon config matching terraform
            addonsConfig:
              httpLoadBalancing:
                disabled: true
              horizontalPodAutoscaling:
                disabled: true
              gcePersistentDiskCsiDriverConfig:
                enabled: true
      patches:
        - fromFieldPath: "spec.location"
          toFieldPath: "spec.forProvider.location"
        - fromFieldPath: "metadata.name"
          toFieldPath: "spec.forProvider.name"

    - name: system-pool
      base:
        apiVersion: container.gcp.upbound.io/v1beta1
        kind: NodePool
        spec:
          forProvider:
            nodeCount: 1
            nodeConfig:
              machineType: "e2-micro"
              diskSizeGb: 20
              diskType: "pd-standard"
              spot: true
              oauthScopes:
                - "https://www.googleapis.com/auth/cloud-platform"
      patches:
        - fromFieldPath: "metadata.name"
          toFieldPath: "spec.forProvider.cluster"
        - fromFieldPath: "spec.location"
          toFieldPath: "spec.forProvider.location"
        - fromFieldPath: "spec.nodePools.system.count"
          toFieldPath: "spec.forProvider.nodeCount"
        - fromFieldPath: "spec.nodePools.system.machineType"
          toFieldPath: "spec.forProvider.nodeConfig.machineType"

    - name: gpu-pool
      base:
        apiVersion: container.gcp.upbound.io/v1beta1
        kind: NodePool
        spec:
          forProvider:
            autoscaling:
              minNodeCount: 0
              maxNodeCount: 1
            nodeConfig:
              machineType: "n1-standard-4"
              diskSizeGb: 100
              diskType: "pd-ssd"
              spot: true
              guestAccelerator:
                count: 1
                gpuDriverInstallationConfig:
                  gpuDriverVersion: "LATEST"
              oauthScopes:
                - "https://www.googleapis.com/auth/cloud-platform"
      patches:
        - fromFieldPath: "metadata.name"
          toFieldPath: "spec.forProvider.cluster"
        - fromFieldPath: "spec.location"
          toFieldPath: "spec.forProvider.location"
        - fromFieldPath: "spec.nodePools.gpu.minCount"
          toFieldPath: "spec.forProvider.autoscaling.minNodeCount"
        - fromFieldPath: "spec.nodePools.gpu.maxCount"
          toFieldPath: "spec.forProvider.autoscaling.maxNodeCount"
        - fromFieldPath: "spec.nodePools.gpu.machineType"
          toFieldPath: "spec.forProvider.nodeConfig.machineType"
        - fromFieldPath: "spec.nodePools.gpu.acceleratorType"
          toFieldPath: "spec.forProvider.nodeConfig.guestAccelerator.type"

    - name: cpu-pool
      base:
        apiVersion: container.gcp.upbound.io/v1beta1
        kind: NodePool
        spec:
          forProvider:
            autoscaling:
              minNodeCount: 0
              maxNodeCount: 3
            nodeConfig:
              machineType: "e2-medium"
              diskSizeGb: 100
              diskType: "pd-ssd"
              spot: true
              oauthScopes:
                - "https://www.googleapis.com/auth/cloud-platform"
      patches:
        - fromFieldPath: "metadata.name"
          toFieldPath: "spec.forProvider.cluster"
        - fromFieldPath: "spec.location"
          toFieldPath: "spec.forProvider.location"
        - fromFieldPath: "spec.nodePools.cpu.minCount"
          toFieldPath: "spec.forProvider.autoscaling.minNodeCount"
        - fromFieldPath: "spec.nodePools.cpu.maxCount"
          toFieldPath: "spec.forProvider.autoscaling.maxNodeCount"
        - fromFieldPath: "spec.nodePools.cpu.machineType"
          toFieldPath: "spec.forProvider.nodeConfig.machineType"

  writeConnectionSecretsToNamespace: crossplane-system
