---
apiVersion: batch/v1
kind: Job
metadata:
  name: liqo-peer
  namespace: crossplane-system
spec:
  template:
    spec:
      serviceAccountName: liqo-installer
      restartPolicy: OnFailure
      initContainers:
        - name: download-tools
          image: alpine/curl:latest
          command:
            - /scripts/setup.sh
          volumeMounts:
            - name: shared
              mountPath: /shared
            - name: scripts
              mountPath: /scripts
              readOnly: true
      containers:
        - name: liqo-setup
          image: google/cloud-sdk:stable
          env:
            - name: CLUSTER_NAME
              value: "worker"
            - name: GCP_PROJECT
              value: "bmas-aus-nbn-vertex-aiml-prod"
            - name: GCP_ZONE
              value: "asia-southeast1-b"
            - name: GKE_CLUSTER_NAME
              value: "test"
          command:
            - /scripts/peer.sh
          volumeMounts:
            - name: shared
              mountPath: /shared
            - name: scripts
              mountPath: /scripts
              readOnly: true
            - name: gcp-credentials
              mountPath: /etc/gcp
              readOnly: true
            - name: service-account-token
              mountPath: /var/run/secrets/kubernetes.io/serviceaccount
              readOnly: true
      volumes:
        - name: shared
          emptyDir: {}
        - name: scripts
          configMap:
            name: liqo-scripts
            defaultMode: 0755
        - name: gcp-credentials
          secret:
            secretName: crossplane
            items:
              - key: GCP_SERVICE_ACCOUNT
                path: credentials.json
        - name: service-account-token
          projected:
            sources:
              - serviceAccountToken:
                  path: token
                  expirationSeconds: 3600
              - configMap:
                  name: kube-root-ca.crt
                  items:
                    - key: ca.crt
                      path: ca.crt
