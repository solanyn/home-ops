apiVersion: planetscale.com/v2
kind: VitessCluster
metadata:
  name: mysql
spec:
  backup:
    engine: xtrabackup
    locations:
      - volume:
          hostPath:
            path: /tmp
            type: Directory
    mysqldExporter: prom/mysqld-exporter:v0.14.0
  cells:
    - name: zone1
      gateway:
        authentication:
          static:
            secret:
              name: vitess-secret
              key: users.json
        replicas: 1
        resources:
          limits:
            memory: 256Mi
  vitessDashboard:
    cells:
      - zone1
    extraFlags:
      security-policy: read-only
    replicas: 1
    resources:
      limits:
        memory: 128Mi
  vtadmin:
    rbac:
      name: vitess-rbac
      key: rbac.yaml
    cells:
      - zone1
    apiAddresses:
      - http://localhost:14001
    replicas: 1
    readOnly: false
    apiResources:
      limits:
        memory: 128Mi
    webResources:
      limits:
        memory: 128Mi

  keyspaces:
    - name: commerce
      durabilityPolicy: none
      turndownPolicy: Immediate
      vitessOrchestrator:
        resources:
          limits:
            memory: 128Mi
        extraFlags:
          instance-poll-time: 1s
      partitionings:
        - equal:
            parts: 1
            shardTemplate:
              databaseInitScriptSecret:
                name: vitess-init-db
                key: init_db.sql
              tabletPools:
                - cell: zone1
                  type: replica
                  replicas: 2
                  vttablet:
                    extraFlags:
                      db-charset: utf8mb4
                    resources:
                      limits:
                        memory: 256Mi
                  mysqld:
                    resources:
                      limits:
                        memory: 1024Mi
                  dataVolumeClaimTemplate:
                    accessModes: ["ReadWriteOnce"]
                    storageClassName: openebs-hostpath
                    resources:
                      requests:
                        storage: 10Gi
  updateStrategy:
    type: Immediate
