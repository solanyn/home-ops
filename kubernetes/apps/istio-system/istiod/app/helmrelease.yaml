---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: istiod
spec:
  chart:
    spec:
      chart: istiod
      version: 1.24.3
      sourceRef:
        kind: HelmRepository
        name: istiod
        namespace: istio-system
  interval: 1h
  values:
    pilot:
      env:
        ENABLE_DEBUG_ON_HTTP: "false"
        ENABLE_NATIVE_SIDECARS: "true"
        PILOT_ENABLE_GATEWAY_API: "true"
      cni:
        enabled: true
        provider: default
      securityContext:
        seccompProfile:
          type: RuntimeDefault
    global:
      podDisruptionBudget:
        enabled: false
      proxy:
        autoInject: enabled
        clusterDomain: cluster.local
        componentLogLevel: "misc:error"
        logLevel: warning
        resources:
          limits:
            cpu: 2000m
            memory: 1024Mi
          requests:
            cpu: 10m
            memory: 64Mi
        startupProbe:
          enabled: true
          failureThreshold: 600
      defaultResources:
        requests:
          cpu: 10m
    sidecarInjectorWebhook:
      enableNamespacesByDefault: false
      rewriteAppHTTPProbe: true
    meshConfig:
      accessLogFile: /dev/stdout
      defaultConfig:
        discoveryAddress: istiod.istio-system.svc:15012
        proxyMetadata: {}
        tracing: {}
      enablePrometheusMerge: true
      rootNamespace: istio-system
      tcpKeepalive:
        interval: 5s
        probes: 3
        time: 10s
      trustDomain: cluster.local
      defaultPodSecurityContext:
        seccompProfile:
          type: RuntimeDefault
      # ExtAuthz config from: third_party/kubeflow/manifests/common/oauth2-proxy/components/istio-external-auth-patches/patches/cm.enable-oauth2-proxy.yaml
      extensionProviders:
        - name: oauth2-proxy
          envoyExtAuthzHttp:
            service: oauth2-proxy.kubeflow.svc.cluster.local
            port: 80
            headersToDownstreamOnDeny:
              - content-type
              - set-cookie
            headersToUpstreamOnAllow:
              - authorization
              - path
              - x-auth-request-email
              - x-auth-request-groups
              - x-auth-request-user
              - kubeflow-userid
            includeRequestHeadersInCheck:
              - authorization
              - cookie
              - x-auth-request-groups
              - x-auth-request-user
