---
apiVersion: admissionregistration.k8s.io/v1beta1
kind: MutatingAdmissionPolicy
metadata:
  name: set-default-container-resources
spec:
  failurePolicy: Fail
  reinvocationPolicy: IfNeeded
  matchConstraints:
    resourceRules:
      - apiGroups: [""]
        apiVersions: ["v1"]
        operations: ["CREATE"]
        resources: ["pods"]
  mutations:
    - patchType: ApplyConfiguration
      applyConfiguration:
        expression: |
          Object{
            spec: Object.spec{
              containers: object.spec.containers.map(c, Object.spec.containers{
                name: c.name,
                resources: Object.spec.containers.resources{
                  requests: Object.spec.containers.resources.requests{
                    cpu: c.resources.?requests.?cpu.orValue("10m"),
                    memory: c.resources.?requests.?memory.orValue("16Mi")
                  }
                }
              }),
              initContainers: object.spec.?initContainers.orValue([]).map(c, Object.spec.initContainers{
                name: c.name,
                resources: Object.spec.initContainers.resources{
                  requests: Object.spec.initContainers.resources.requests{
                    cpu: c.resources.?requests.?cpu.orValue("10m"),
                    memory: c.resources.?requests.?memory.orValue("16Mi")
                  }
                }
              })
            }
          }
---
apiVersion: admissionregistration.k8s.io/v1beta1
kind: MutatingAdmissionPolicyBinding
metadata:
  name: set-default-container-resources
spec:
  policyName: set-default-container-resources
  matchResources: {}
