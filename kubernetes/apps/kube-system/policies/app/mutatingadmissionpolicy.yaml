---
apiVersion: admissionregistration.k8s.io/v1alpha1
kind: MutatingAdmissionPolicyBinding
metadata:
  name: pod-requests
spec:
  policyName: pod-requests
---
apiVersion: admissionregistration.k8s.io/v1alpha1
kind: MutatingAdmissionPolicy
metadata:
  name: pod-requests
spec:
  matchConstraints:
    resourceRules:
      - apiGroups: [""]
        apiVersions: ["v1"]
        operations: ["CREATE"]
        resources: ["pods"]
  failurePolicy: Fail
  reinvocationPolicy: IfNeeded
  mutations:
    - patchType: JSONPatch
      jsonPatch:
        expression: |
          object.spec.containers.map(container, 
            JSONPatch{
              op: "add",
              path: "/spec/containers/" + string(object.spec.containers.indexOf(container)) + "/resources/requests/cpu",
              value: "10m"
            }
          ) +
          object.spec.containers.map(container, 
            JSONPatch{
              op: "add", 
              path: "/spec/containers/" + string(object.spec.containers.indexOf(container)) + "/resources/requests/memory",
              value: "64Mi"
            }
          )
    - patchType: JSONPatch
      jsonPatch:
        expression: |
          has(object.spec.initContainers) ?
            object.spec.initContainers.map(container,
              JSONPatch{
                op: "add",
                path: "/spec/initContainers/" + string(object.spec.initContainers.indexOf(container)) + "/resources/requests/cpu", 
                value: "10m"
              }
            ) +
            object.spec.initContainers.map(container,
              JSONPatch{
                op: "add",
                path: "/spec/initContainers/" + string(object.spec.initContainers.indexOf(container)) + "/resources/requests/memory",
                value: "64Mi"
              }
            ) : []
