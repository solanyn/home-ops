# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"
vars:
  BREWFILE: "{{.ROOT_DIR}}/.taskfiles/workstation/Brewfile"
  GENERIC_BIN_DIR: "{{.ROOT_DIR}}/.bin"
  MINIJINJA_CMD: '{{ .HOME }}/.cargo/bin/minijinja-cli --env --trim-blocks --lstrip-blocks --autoescape=none --strict'
tasks:
  direnv:
    desc: Run direnv hooks
    cmd: direnv allow .
    status:
      - "[[ $(direnv status --json | jq '.state.foundRC.allowed') == 0 ]]"
      - "[[ $(direnv status --json | jq '.state.loadedRC.allowed') == 0 ]]"
  venv:
    desc: Set up virtual environment
    cmds:
      - "uv venv"
      - 'uv pip install --upgrade pip setuptools wheel'
      - 'uv pip install --upgrade --requirement "{{.PIP_REQUIREMENTS_FILE}}"'
    sources:
      - "{{.PIP_REQUIREMENTS_FILE}}"
    generates:
      - "{{.VIRTUAL_ENV}}/pyvenv.cfg"
    preconditions:
      - {msg: "Missing Pip requirements file", sh: "test -f {{.PIP_REQUIREMENTS_FILE}}"}
  deps:
    desc: Install workstation dependencies
    cmds:
      - brew bundle --file {{.BREWFILE}}
      - curl -sSfL https://github.com/mitsuhiko/minijinja/releases/latest/download/minijinja-cli-installer.sh | sh
    preconditions:
      - {msg: "Missing Homebrew", sh: "command -v brew"}
      - {msg: "Missing Brewfile", sh: "test -f {{.BREWFILE}}"}
      - {msg: "Missing uv", sh: "command -v uv"}
