name: Sync Kubeflow Manifests (Matrix)

on:
  schedule:
    - cron: '0 0 * * *'  # Daily at 00:00 UTC
  workflow_dispatch:
    inputs:
      upstream_ref:
        description: 'Kubeflow tag or branch to sync (leave blank to auto-detect latest tag)'
        required: false
        default: ''

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      upstream_ref: ${{ steps.ref.outputs.ref }}
      previous_ref: ${{ steps.prev.outputs.prev }}
    steps:
      - name: Get latest tag if none provided
        id: ref
        run: |
          if [ -z "${{ github.event.inputs.upstream_ref }}" ]; then
            latest=$(git ls-remote --tags https://github.com/kubeflow/manifests.git | grep -o 'refs/tags/.*' | sed 's|refs/tags/||' | sort -V | tail -n1)
            echo "Auto-detected latest tag: $latest"
            echo "ref=$latest" >> $GITHUB_OUTPUT
          else
            echo "ref=${{ github.event.inputs.upstream_ref }}" >> $GITHUB_OUTPUT
          fi

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get previously synced upstream ref
        id: prev
        run: |
          if [[ -f .last-upstream-ref ]]; then
            echo "prev=$(cat .last-upstream-ref)" >> $GITHUB_OUTPUT
          else
            echo "prev=unknown" >> $GITHUB_OUTPUT
          fi

  sync:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      matrix:
        folder: [common, apps, experimental, example]
    outputs:
      changed: ${{ steps.check.outputs.changed }}
    env:
      DEST_BASE: kubernetes/apps/kubeflow-system/platform/manifests
    steps:
      - uses: actions/checkout@v4

      - name: Clone upstream
        run: |
          git clone --depth=1 --branch "${{ needs.setup.outputs.upstream_ref }}" https://github.com/kubeflow/manifests.git upstream

      - name: Check and sync folder
        id: check
        run: |
          src="upstream/${{ matrix.folder }}"
          dest="${DEST_BASE}/${{ matrix.folder }}"
          mkdir -p "tmp-sync"
          cp -r "$src" "tmp-sync/"

          # Ensure destination folder exists
          mkdir -p "$dest"

          if ! diff -qr "tmp-sync/${{ matrix.folder }}" "$dest" > /dev/null; then
            echo "🔁 Changes found in ${{ matrix.folder }}"
            rm -rf "$dest"/*
            cp -r "tmp-sync/${{ matrix.folder }}"/* "$dest/"
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "✅ No changes in ${{ matrix.folder }}"
            echo "changed=false" >> $GITHUB_OUTPUT

      - name: Upload updated folder
        if: steps.check.outputs.changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: synced-${{ matrix.folder }}
          path: ${{ env.DEST_BASE }}/${{ matrix.folder }}

  finalize:
    needs: [setup, sync]
    runs-on: ubuntu-latest
    if: contains(needs.sync.*.outputs.changed, 'true')
    steps:
      - uses: actions/checkout@v4

      - name: Download synced folders
        uses: actions/download-artifact@v4
        with:
          pattern: synced-*
          path: kubernetes/apps/kubeflow-system/platform/manifests

      - name: Save updated upstream ref
        run: echo "${{ needs.setup.outputs.upstream_ref }}" > .last-upstream-ref

      - name: Generate changelog
        id: changelog
        run: |
          git clone https://github.com/kubeflow/manifests.git full-upstream
          cd full-upstream
          git fetch --tags
          from="${{ needs.setup.outputs.previous_ref }}"
          to="${{ needs.setup.outputs.upstream_ref }}"
          if [[ "$from" == "unknown" ]]; then
            log=$(git log -n 20 --oneline "$to")
          else
            log=$(git log --oneline "$from..$to" || echo "No changelog available.")
          fi
          echo "CHANGELOG<<EOF" >> $GITHUB_ENV
          echo "$log" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Commit and push
        run: |
          git config user.email "${BOT_APP_ID}+bot-goyangi[bot]@users.noreply.github.com"
          git config user.name "bot-goyangi[bot]"
          BRANCH="kubeflow-sync-${{ needs.setup.outputs.upstream_ref }}-$(date +%s)"
          git checkout -b "$BRANCH"
          git add kubernetes/apps/kubeflow-system/platform/manifests .last-upstream-ref
          git commit -m "chore: sync Kubeflow manifests from ${{ needs.setup.outputs.upstream_ref }}"
          git push origin "$BRANCH"
          echo "BRANCH_NAME=$BRANCH" >> $GITHUB_ENV

      - name: Get diff summary
        id: diff
        run: |
          summary=$(git diff --stat HEAD~1 HEAD)
          echo "DIFF<<EOF" >> $GITHUB_ENV
          echo "$summary" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: Update Kubeflow manifests from ${{ needs.setup.outputs.upstream_ref }}
          branch: ${{ env.BRANCH_NAME }}
          title: "Sync Kubeflow manifests from ${{ needs.setup.outputs.upstream_ref }}"
          body: |
            ## 📦 Synced Kubeflow Manifests

            Folders synced from upstream ref: `${{ needs.setup.outputs.upstream_ref }}`
            to `kubernetes/apps/kubeflow-system/platform/manifests`.

            🔄 **From:** `${{ needs.setup.outputs.previous_ref }}`
            🚀 **To:** `${{ needs.setup.outputs.upstream_ref }}`

            ## 📜 Changelog
            ```
            ${{ env.CHANGELOG }}
            ```

            ## 📊 Diff Summary
            ```
            ${{ env.DIFF }}
            ```

